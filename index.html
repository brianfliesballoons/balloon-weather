<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Balloon Weather</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;700&family=JetBrains+Mono:wght@300;400;500;700&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0a0e1a;--card:#111827;--card2:#0f1525;--bdr:#1e293b;--bdr2:#2a3a52;
  --tx:#e8ecf4;--tx2:#8b97b0;--tx3:#5a6680;--tx4:#3d4a60;
  --calm:#34d399;--mod:#fbbf24;--strong:#fb923c;--danger:#f87171;
  --blue:#38bdf8;--cyan:#22d3ee;--violet:#a78bfa;
  --gust:#ff6b35;--gust-bg:rgba(255,107,53,.08);--gust-bdr:rgba(255,107,53,.25);
  --ks:#ef4444;--kp:#3b82f6;--km:#06b6d4;--kf:#a855f7;--kw:#f59e0b;--kt:#ec4899;
  --r:12px;--rs:8px;--sh:0 2px 12px rgba(0,0,0,.25);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:5px;height:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--bdr2);border-radius:3px}

.hdr{background:rgba(10,14,26,.88);backdrop-filter:blur(16px);border-bottom:1px solid var(--bdr);padding:12px 24px;display:flex;align-items:center;justify-content:space-between;z-index:100}
.hdr-l{display:flex;align-items:center;gap:12px}
.logo{width:36px;height:36px;background:linear-gradient(135deg,var(--mod),#f97316);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.hdr-title{font-family:'Instrument Serif',serif;font-size:21px}
.hdr-sub{font-size:11px;color:var(--tx3);margin-top:-2px}
.hdr-r{display:flex;align-items:center;gap:14px}
.upd{font-size:10px;color:var(--tx3);font-family:'JetBrains Mono',monospace}
.rbtn{background:var(--card);border:1px solid var(--bdr);color:var(--tx2);padding:6px 13px;border-radius:var(--rs);cursor:pointer;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:500;transition:all .15s;display:flex;align-items:center;gap:5px}
.rbtn:hover{background:var(--card2);border-color:var(--bdr2);color:var(--tx)}
.rbtn.ld .ri{animation:sp .8s linear infinite}@keyframes sp{to{transform:rotate(360deg)}}.ri{display:inline-block}

.ga{background:var(--gust-bg);border:1px solid var(--gust-bdr);border-radius:var(--rs);padding:10px 18px;margin:12px 24px 0;display:none;align-items:center;gap:10px;font-size:13px;font-weight:500;color:var(--gust);animation:pulse 3s ease-in-out infinite}
.ga.v{display:flex}@keyframes pulse{0%,100%{border-color:rgba(255,107,53,.25)}50%{border-color:rgba(255,107,53,.5)}}

.dash{max-width:1400px;margin:0 auto;padding:16px 24px 60px;display:grid;grid-template-columns:1fr 1fr;gap:14px}
.full{grid-column:1/-1}
@media(max-width:900px){
.dash{grid-template-columns:1fr;padding:12px 14px 40px}.full{grid-column:1}
/* Header: stack vertically and center */
.hdr{flex-direction:column;gap:8px;padding:10px 16px;text-align:center}
.hdr-l{justify-content:center}
.hdr-r{justify-content:center;flex-wrap:wrap;gap:8px}
.hdr-title{font-size:19px}
.hdr-sub{font-size:10px}
/* Surface stats: bigger fonts */
.stat-lbl{font-size:13px}
.stat-val{font-size:18px}
.stat-sub{font-size:12px}
.cspeed .big{font-size:48px}
.cspeed .dir{font-size:15px}
/* Winds aloft: bigger fonts */
.vf-alt{font-size:12px;width:75px;min-width:75px}
.vf-alt .msl{font-size:10px}
.vf-spd{font-size:14px}
.vf-info{font-size:12px}
.vf-dist{font-size:9px}
.vf-cell{height:65px}
/* Micro winds: bigger fonts */
.mvf-alt{font-size:11px;width:70px;min-width:70px}
.mvf-alt .msl{font-size:9px}
.mvf-cell{height:32px;font-size:12px}
.mvf-shear .mvf-cell{font-size:10px}
/* Shear bars */
.vf-shear .vf-alt{font-size:10px}
.vf-shear .vf-cell{font-size:11px}
/* Surface comparison grid */
.sc-title{font-size:12px}
/* Card headers */
.ct{font-size:13px}
.ct .sub{font-size:12px}
.badge{font-size:11px}
.body{padding:14px 12px}
/* Surface: left-align compass+stats, stack vertically */
.cw{justify-content:flex-start;gap:20px}
}

.cd{background:var(--card);border:1px solid var(--bdr);border-radius:var(--r);box-shadow:var(--sh);overflow:visible;transition:border-color .2s}.cd:hover{border-color:var(--bdr2)}
.ch{padding:12px 18px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(30,41,59,.5);position:sticky;top:0;z-index:10;background:var(--card);border-radius:var(--r) var(--r) 0 0}
.ct{font-size:12px;font-weight:600;color:var(--tx2);text-transform:uppercase;letter-spacing:.06em;display:flex;align-items:center;gap:7px}
.ct .sub{font-weight:400;color:var(--tx3);text-transform:none;letter-spacing:0;font-size:11px;margin-left:4px}
.badge{font-size:10px;font-family:'JetBrains Mono',monospace;background:rgba(56,189,248,.1);color:var(--blue);padding:2px 8px;border-radius:12px;text-decoration:none;transition:background .15s,color .15s}
a.badge{cursor:pointer}a.badge:hover{background:rgba(56,189,248,.2);color:#7dd3fc}
.body{padding:16px 18px}
.ch.tg{cursor:pointer;user-select:none;transition:background .15s}.ch.tg:hover{background:rgba(255,255,255,.02)}
.ch.tg .chv{transition:transform .25s;font-size:12px;color:var(--tx3);margin-left:8px;flex-shrink:0}
.ch.tg.open .chv{transform:rotate(180deg)}.hide{display:none}

/* ‚ïê‚ïê‚ïê COMPASS ‚ïê‚ïê‚ïê */
.cw{display:flex;align-items:center;justify-content:flex-start;gap:40px;flex-wrap:wrap;padding:8px 0}
.cbox{position:relative;width:210px;height:210px}
.cring{width:100%;height:100%;border-radius:50%;border:2px solid var(--bdr);position:relative;background:radial-gradient(circle,rgba(17,24,39,.6),rgba(15,21,37,.95))}
.ctick{position:absolute;width:1px;height:8px;background:var(--tx4);top:4px;left:50%;transform-origin:0.5px 101px}
.clbl{position:absolute;font-size:11px;font-weight:700;color:var(--tx3);font-family:'JetBrains Mono',monospace}
.clbl.n{top:10px;left:50%;transform:translateX(-50%)}.clbl.s{bottom:10px;left:50%;transform:translateX(-50%)}
.clbl.e{right:12px;top:50%;transform:translateY(-50%)}.clbl.w{left:12px;top:50%;transform:translateY(-50%)}
.cneedle{position:absolute;top:50%;left:50%;transform-origin:center center;transition:transform .6s cubic-bezier(.4,0,.2,1)}
.cdot{position:absolute;top:50%;left:50%;width:8px;height:8px;border-radius:50%;background:var(--tx);transform:translate(-50%,-50%);z-index:2;box-shadow:0 0 6px rgba(255,255,255,.3)}
.cspeed{text-align:center;margin-top:14px;font-family:'JetBrains Mono',monospace}
.cspeed .big{font-size:44px;font-weight:700;line-height:1}.cspeed .unit{font-size:14px;color:var(--tx2);margin-left:3px}
.cspeed .dir{font-size:14px;color:var(--tx2);margin-top:2px}

/* ‚ïê‚ïê‚ïê STATS ‚ïê‚ïê‚ïê */
.stats{display:flex;flex-direction:column;gap:10px;min-width:210px}
.stat{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--card2);border-radius:var(--rs)}
.stat-lbl{font-size:11px;color:var(--tx3);font-weight:500}
.stat-val{font-family:'JetBrains Mono',monospace;font-size:16px;font-weight:600}
.stat-sub{font-size:10px;color:var(--tx3);font-family:'JetBrains Mono',monospace}
.gauge{height:4px;border-radius:2px;background:var(--bdr);margin-top:4px;overflow:hidden}
.gauge-fill{height:100%;border-radius:2px;transition:width .4s ease}

/* ‚ïê‚ïê‚ïê WIND PROFILE ‚Äî VECTOR FIELD ‚ïê‚ïê‚ïê */
.vf-scroll{overflow:auto;padding-bottom:6px;-webkit-overflow-scrolling:touch;max-height:70vh}
.vf-wrap{padding:10px 0;display:inline-flex;flex-direction:column;min-width:100%}
.vf-row{display:flex;align-items:center;gap:0;margin-bottom:2px}
.vf-alt{width:70px;min-width:70px;flex-shrink:0;text-align:right;padding-right:10px;font-size:10px;color:var(--tx3);font-family:'JetBrains Mono',monospace;white-space:nowrap}
.vf-alt .msl{font-size:8px;color:var(--tx4);display:block}
.vf-cell{width:140px;min-width:140px;max-width:140px;flex-shrink:0;height:60px;position:relative;display:flex;align-items:center;justify-content:center;gap:4px;border-bottom:1px solid rgba(30,41,59,.3);overflow:hidden}
.vf-arrow-wrap{position:relative;display:flex;align-items:center;justify-content:center}
.vf-hdr{background:var(--card);margin-bottom:4px;padding:6px 0 4px;border-bottom:1px solid var(--bdr);position:sticky;top:0;z-index:5}
.vf-info{width:140px;min-width:140px;flex-shrink:0;padding-left:12px;font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--tx2);white-space:nowrap;display:flex;align-items:center;gap:6px}
.vf-spd{font-weight:600;font-size:12px}
.vf-dist{font-size:8px;color:var(--tx4);font-family:'JetBrains Mono',monospace;margin-top:1px}

/* ‚ïê‚ïê‚ïê WIND SHEAR BARS ‚ïê‚ïê‚ïê */
.vf-shear{display:flex;align-items:center;gap:0;margin:0;height:22px;background:rgba(251,191,36,.1);border-top:1.5px solid rgba(251,191,36,.35);border-bottom:1.5px solid rgba(251,191,36,.35)}
.vf-shear.strong{background:rgba(255,107,53,.1);border-color:rgba(255,107,53,.35)}
.vf-shear .vf-alt{font-size:8px;color:var(--mod);font-weight:600}
.vf-shear.strong .vf-alt{color:var(--gust)}
.vf-shear .vf-cell{height:22px;border:none;justify-content:flex-start;padding-left:6px;font-size:9px;font-family:'JetBrains Mono',monospace;color:var(--mod);font-weight:600}
.vf-shear.strong .vf-cell{color:var(--gust)}

/* ‚ïê‚ïê‚ïê MICRO WINDS ALOFT ‚ïê‚ïê‚ïê */
.mvf-scroll{overflow-x:auto;padding-bottom:4px;-webkit-overflow-scrolling:touch}
.mvf-wrap{padding:6px 0;display:flex;flex-direction:column;min-width:100%}
.mvf-row{display:flex;align-items:center;gap:0;margin-bottom:1px}
.mvf-alt{width:65px;min-width:65px;flex-shrink:0;text-align:right;padding-right:8px;font-size:9px;color:var(--tx3);font-family:'JetBrains Mono',monospace;white-space:nowrap}
.mvf-alt .msl{font-size:7px;color:var(--tx4);display:block}
.mvf-cell{width:200px;min-width:200px;flex-shrink:0;height:28px;display:flex;align-items:center;justify-content:flex-start;gap:6px;padding-left:4px;border-bottom:1px solid rgba(30,41,59,.2);overflow:hidden}
.mvf-hdr{background:var(--card);margin-bottom:3px;padding:4px 0;border-bottom:1px solid var(--bdr)}
.mvf-shear{display:flex;align-items:center;gap:0;margin:0;height:18px;background:rgba(251,191,36,.1);border-top:1px solid rgba(251,191,36,.3);border-bottom:1px solid rgba(251,191,36,.3)}
.mvf-shear.strong{background:rgba(255,107,53,.1);border-color:rgba(255,107,53,.3)}
.mvf-shear .mvf-alt{font-size:7px;color:var(--mod);font-weight:600}
.mvf-shear.strong .mvf-alt{color:var(--gust)}
.mvf-shear .mvf-cell{height:18px;border:none;font-size:8px;font-family:'JetBrains Mono',monospace;color:var(--mod);font-weight:600}
.mvf-shear.strong .mvf-cell{color:var(--gust)}

/* ‚ïê‚ïê‚ïê WINDS PAIR LAYOUT ‚ïê‚ïê‚ïê */
.winds-pair{display:flex;gap:14px;align-items:stretch}
.winds-micro{width:280px;min-width:280px;flex-shrink:0}
.winds-main{flex:1;min-width:0;overflow:hidden}
@media(max-width:900px){.winds-pair{flex-direction:column}.winds-micro{width:100%;min-width:0}}

/* ‚ïê‚ïê‚ïê SURFACE COMPARISON GRID ‚ïê‚ïê‚ïê */
.sc-wrap{margin-top:16px;padding-top:14px;border-top:1px solid var(--bdr)}
.sc-title{font-size:10px;text-transform:uppercase;letter-spacing:.06em;color:var(--tx3);font-weight:600;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.sc-scroll{overflow:auto;padding-bottom:6px;-webkit-overflow-scrolling:touch;max-height:60vh}
.sc-grid{display:inline-flex;flex-direction:column;min-width:100%}
.sc-row{display:flex;align-items:center;gap:0;margin-bottom:1px}
.sc-lbl{width:90px;min-width:90px;flex-shrink:0;text-align:right;padding-right:10px;font-size:10px;color:var(--tx3);font-family:'JetBrains Mono',monospace;white-space:nowrap}
.sc-cell{width:120px;min-width:120px;max-width:120px;flex-shrink:0;height:32px;display:flex;align-items:center;justify-content:center;font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:600;border-bottom:1px solid rgba(30,41,59,.2);overflow:hidden}
.sc-hdr{background:var(--card);padding:4px 0;border-bottom:1px solid var(--bdr);margin-bottom:3px;position:sticky;top:0;z-index:5}
.sc-hdr .sc-cell{height:auto;border:none;flex-direction:column;gap:1px;padding:4px 2px}

/* ‚ïê‚ïê‚ïê HOURLY ‚ïê‚ïê‚ïê */
.hstrip{display:flex;gap:2px;overflow-x:auto;padding-bottom:6px}
.hcol{flex:0 0 52px;display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 3px;border-radius:6px;transition:background .15s;cursor:pointer}
.hcol:hover{background:rgba(255,255,255,.05)}.hcol.gy{background:var(--gust-bg);border:1px solid var(--gust-bdr)}
.hcol.sel{background:rgba(56,189,248,.08);border:1px solid rgba(56,189,248,.25);box-shadow:0 0 8px rgba(56,189,248,.1)}
.htime{font-size:8px;color:var(--tx3);font-family:'JetBrains Mono',monospace;font-weight:500}
.htemp{font-size:13px;font-weight:600;font-family:'JetBrains Mono',monospace}
.hspd{font-size:9px;font-family:'JetBrains Mono',monospace;font-weight:500}
.hgust{font-size:8px;color:var(--gust);font-weight:600;font-family:'JetBrains Mono',monospace}
.hdir{font-size:7px;color:var(--tx3);font-family:'JetBrains Mono',monospace}
.hprc{font-size:8px;color:var(--blue);font-family:'JetBrains Mono',monospace;font-weight:600}
.hcb{font-size:7px;color:var(--tx4);font-family:'JetBrains Mono',monospace}
.ceil-wrap{margin-top:14px;padding-top:12px;border-top:1px solid var(--bdr)}
.ceil-lbl{font-size:10px;text-transform:uppercase;letter-spacing:.06em;color:var(--tx3);font-weight:600;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.ceil-stn{display:flex;align-items:center;gap:8px;padding:4px 0;font-family:'JetBrains Mono',monospace;font-size:11px}
.ceil-id{color:var(--blue);width:36px;font-weight:600;font-size:10px;flex-shrink:0}
.ceil-nm{color:var(--tx4);font-size:9px;width:60px;flex-shrink:0}
.ceil-layers{display:flex;gap:6px;flex-wrap:wrap}
.ceil-layer{padding:2px 8px;border-radius:4px;font-size:10px;font-weight:500}
.ceil-layer.few{background:rgba(52,211,153,.08);color:var(--calm)}
.ceil-layer.sct{background:rgba(251,191,36,.08);color:var(--mod)}
.ceil-layer.bkn{background:rgba(251,146,60,.08);color:var(--strong)}
.ceil-layer.ovc{background:rgba(248,113,113,.08);color:var(--danger)}
.ceil-layer.clr{background:rgba(52,211,153,.06);color:var(--calm)}
.hcbar{width:22px;height:3px;border-radius:2px;background:var(--bdr);overflow:hidden;margin-top:1px}
.hcfill{height:100%;background:var(--tx3);border-radius:2px}
.hdet{margin-top:12px;padding:14px 16px;background:var(--card2);border:1px solid var(--bdr2);border-radius:var(--rs);display:none;animation:hdetIn .2s ease}
.hdet.v{display:block}
@keyframes hdetIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
.hdet-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.hdet-time{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;color:var(--blue)}
.hdet-close{background:none;border:none;color:var(--tx3);cursor:pointer;font-size:16px;padding:2px 6px;border-radius:4px}.hdet-close:hover{color:var(--tx);background:rgba(255,255,255,.05)}
.hdet-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
@media(max-width:500px){.hdet-grid{grid-template-columns:1fr 1fr}}
.hdet-item{padding:8px 10px;background:var(--card);border-radius:6px}
.hdet-lbl{font-size:9px;color:var(--tx3);text-transform:uppercase;letter-spacing:.04em;margin-bottom:3px}
.hdet-val{font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:600}
.hdet-sub{font-size:9px;color:var(--tx4);font-family:'JetBrains Mono',monospace;margin-top:1px}


/* ‚ïê‚ïê‚ïê AFD ‚ïê‚ïê‚ïê */
.afd-split{display:flex;gap:12px;align-items:stretch;min-height:320px}
.afd-notes{flex:0 0 220px;min-width:0;max-width:220px;display:flex;flex-direction:column;gap:8px;overflow-y:auto;max-height:500px;padding-right:4px}
.afd-disc{flex:1;min-width:0;display:flex;flex-direction:column}
.asum{padding:10px 10px;background:var(--card2);border-radius:var(--rs)}
.asmt{font-size:9px;text-transform:uppercase;letter-spacing:.06em;color:var(--tx3);font-weight:600;margin-bottom:5px}
.akws{display:flex;flex-wrap:wrap;gap:4px}
.akw{font-size:9px;padding:2px 7px;border-radius:14px;font-weight:500;font-family:'JetBrains Mono',monospace}
.akw.ks{background:rgba(239,68,68,.12);color:var(--ks)}.akw.kp{background:rgba(59,130,246,.12);color:var(--kp)}
.akw.km{background:rgba(6,182,212,.12);color:var(--km)}.akw.kf{background:rgba(168,85,247,.12);color:var(--kf)}
.akw.kw{background:rgba(245,158,11,.12);color:var(--kw)}.akw.kt{background:rgba(236,72,153,.12);color:var(--kt)}
.apts{list-style:none;display:flex;flex-direction:column;gap:6px}
.apt{font-size:11px;color:var(--tx);line-height:1.45;padding:6px 8px;border-radius:var(--rs);border-left:3px solid var(--tx3);background:var(--card2)}
.apt.ks{border-left-color:var(--ks);background:rgba(239,68,68,.04)}.apt.kp{border-left-color:var(--kp);background:rgba(59,130,246,.04)}
.apt.km{border-left-color:var(--km);background:rgba(6,182,212,.04)}.apt.kf{border-left-color:var(--kf);background:rgba(168,85,247,.04)}
.apt.kw{border-left-color:var(--kw);background:rgba(245,158,11,.04)}.apt.kt{border-left-color:var(--kt);background:rgba(236,72,153,.04)}
.atog{display:none}
.afull{padding:14px;background:var(--card2);border-radius:var(--rs);font-family:'JetBrains Mono',monospace;font-size:11px;line-height:1.65;color:var(--tx2);white-space:pre-wrap;word-wrap:break-word;overflow-wrap:break-word;max-height:500px;overflow-y:auto;flex:1}
.afull .hs0{color:var(--ks);font-weight:600;background:rgba(239,68,68,.1);padding:0 2px;border-radius:2px}
.afull .hp0{color:var(--kp);font-weight:600;background:rgba(59,130,246,.1);padding:0 2px;border-radius:2px}
.afull .hm0{color:var(--km);font-weight:600;background:rgba(6,182,212,.1);padding:0 2px;border-radius:2px}
.afull .hf0{color:var(--kf);font-weight:600;background:rgba(168,85,247,.1);padding:0 2px;border-radius:2px}
.afull .hw0{color:var(--kw);font-weight:600;background:rgba(245,158,11,.1);padding:0 2px;border-radius:2px}
.afull .ht0{color:var(--kt);font-weight:600;background:rgba(236,72,153,.1);padding:0 2px;border-radius:2px}
.aext{display:inline-block;margin-top:6px;font-size:9px;color:var(--blue);text-decoration:none;font-family:'JetBrains Mono',monospace}.aext:hover{text-decoration:underline}
@media(max-width:900px){
.afd-split{min-height:250px;gap:8px}
.afd-notes{flex:0 0 45%;max-width:45%;max-height:500px}
.apt{font-size:12px;line-height:1.5;padding:6px 8px}
.akw{font-size:10px}
.afull{max-height:500px;font-size:10px;line-height:1.6}
}

.efr{width:100%;height:420px;border:none;border-radius:var(--rs);background:var(--card2)}
.ldg{display:flex;align-items:center;justify-content:center;padding:30px;gap:6px}
.dot{width:5px;height:5px;border-radius:50%;background:var(--blue);animation:dp 1.2s ease-in-out infinite}
.dot:nth-child(2){animation-delay:.15s}.dot:nth-child(3){animation-delay:.3s}
@keyframes dp{0%,80%,100%{opacity:.2;transform:scale(.8)}40%{opacity:1;transform:scale(1.1)}}
.err{padding:12px;font-size:11px;color:var(--danger);font-family:'JetBrains Mono',monospace;background:rgba(248,113,113,.06);border-radius:var(--rs)}

.dtable{width:100%;border-collapse:collapse;font-family:'JetBrains Mono',monospace;font-size:11px;margin-top:12px}
.dtable th{text-align:left;padding:6px 8px;font-size:9px;text-transform:uppercase;letter-spacing:.05em;color:var(--tx3);font-weight:600;border-bottom:1px solid var(--bdr)}
.dtable td{padding:5px 8px;border-bottom:1px solid rgba(30,41,59,.4);white-space:nowrap}.dtable tr:hover td{background:rgba(56,189,248,.02)}

/* ‚ïê‚ïê‚ïê LOCATION SEARCH ‚ïê‚ïê‚ïê */
.loc-ov{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(6px);z-index:200;display:none;align-items:flex-start;justify-content:center;padding-top:80px}
.loc-ov.v{display:flex}
.loc-panel{background:var(--card);border:1px solid var(--bdr2);border-radius:var(--r);width:90%;max-width:440px;box-shadow:0 8px 40px rgba(0,0,0,.5);overflow:hidden}
.loc-hd{padding:14px 18px;border-bottom:1px solid var(--bdr);display:flex;align-items:center;justify-content:space-between}
.loc-hd-t{font-size:13px;font-weight:600;color:var(--tx2);text-transform:uppercase;letter-spacing:.05em}
.loc-close{background:none;border:none;color:var(--tx3);cursor:pointer;font-size:18px;padding:2px 6px;border-radius:4px}.loc-close:hover{color:var(--tx);background:rgba(255,255,255,.05)}
.loc-body{padding:14px 18px}
.loc-cur{font-size:11px;color:var(--tx3);margin-bottom:10px;font-family:'JetBrains Mono',monospace}
.loc-cur span{color:var(--blue);font-weight:600}
.loc-row{display:flex;gap:8px}
.loc-input{flex:1;background:var(--card2);border:1px solid var(--bdr);color:var(--tx);padding:9px 14px;border-radius:var(--rs);font-family:'DM Sans',sans-serif;font-size:13px;outline:none;transition:border-color .15s}
.loc-input:focus{border-color:var(--blue)}
.loc-input::placeholder{color:var(--tx4)}
.loc-go{background:rgba(56,189,248,.12);border:1px solid rgba(56,189,248,.25);color:var(--blue);padding:9px 16px;border-radius:var(--rs);cursor:pointer;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;transition:all .15s}
.loc-go:hover{background:rgba(56,189,248,.2)}
.loc-results{margin-top:10px;display:flex;flex-direction:column;gap:4px}
.loc-item{padding:10px 14px;background:var(--card2);border:1px solid var(--bdr);border-radius:var(--rs);cursor:pointer;transition:all .15s}
.loc-item:hover{border-color:var(--blue);background:rgba(56,189,248,.04)}
.loc-item-name{font-size:13px;font-weight:600;color:var(--tx)}
.loc-item-sub{font-size:10px;color:var(--tx3);margin-top:2px;font-family:'JetBrains Mono',monospace}
.loc-msg{font-size:11px;margin-top:10px;padding:8px 12px;border-radius:var(--rs);font-family:'JetBrains Mono',monospace}
.loc-msg.err{color:var(--danger);background:rgba(248,113,113,.06)}
.loc-msg.info{color:var(--blue);background:rgba(56,189,248,.06)}
.loc-msg.ok{color:var(--calm);background:rgba(52,211,153,.06)}

/* ‚ïê‚ïê‚ïê AVIATION BRIEFING ‚ïê‚ïê‚ïê */
.ab-sec{margin-bottom:14px;padding:12px 14px;background:var(--card2);border-radius:var(--rs)}
.ab-sec:last-child{margin-bottom:0}
.ab-st{font-size:10px;text-transform:uppercase;letter-spacing:.06em;color:var(--tx3);font-weight:600;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.ab-item{padding:8px 0;border-bottom:1px solid rgba(30,41,59,.3);font-size:11px;line-height:1.5}
.ab-item:last-child{border-bottom:none}
.ab-stn{font-family:'JetBrains Mono',monospace;color:var(--blue);font-weight:700;font-size:11px}
.ab-tm{font-size:9px;color:var(--tx3);font-family:'JetBrains Mono',monospace;margin-left:6px}
.ab-raw{background:var(--card);padding:8px 10px;border-radius:var(--rs);margin-top:6px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--tx2);white-space:pre-wrap;word-wrap:break-word;line-height:1.6}
.ab-haz{display:inline-block;padding:2px 9px;border-radius:12px;font-size:9px;font-weight:600;margin-right:6px;font-family:'JetBrains Mono',monospace}
.ab-haz.sig{background:rgba(248,113,113,.12);color:var(--danger)}
.ab-haz.air{background:rgba(251,146,60,.12);color:var(--strong)}
.ab-haz.pir{background:rgba(56,189,248,.12);color:var(--blue)}
.ab-haz.gair{background:rgba(168,85,247,.12);color:var(--violet)}
.ab-tfr{display:inline-block;padding:7px 16px;background:rgba(245,158,11,.1);color:var(--kw);border:1px solid rgba(245,158,11,.25);border-radius:var(--rs);text-decoration:none;font-size:11px;font-weight:600;font-family:'DM Sans',sans-serif;transition:all .15s}
.ab-tfr:hover{background:rgba(245,158,11,.2);border-color:rgba(245,158,11,.4)}
.ab-none{font-size:11px;color:var(--tx3);padding:8px 0;text-align:center}
.ab-links{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;padding-top:12px;border-top:1px solid var(--bdr)}
.ab-links a{font-size:10px;color:var(--blue);text-decoration:none;font-family:'JetBrains Mono',monospace}.ab-links a:hover{text-decoration:underline}
</style>
</head>
<body>
<header class="hdr"><div class="hdr-l"><div class="logo">üéà</div><div><div class="hdr-title" id="hdrTitle">Balloon Weather</div><div class="hdr-sub" id="hdrSub">Loading...</div></div></div><div class="hdr-r"><div class="upd" id="upd">‚Äî</div><button class="rbtn" onclick="openLoc()">üìç Location</button><button class="rbtn" id="rbtn" onclick="refreshAll()"><span class="ri">‚Üª</span> Refresh</button></div></header>
<div class="loc-ov" id="locOv"><div class="loc-panel"><div class="loc-hd"><span class="loc-hd-t">Set Location</span><button class="loc-close" onclick="closeLoc()">‚úï</button></div><div class="loc-body"><div class="loc-cur" id="locCur"></div><div class="loc-row"><input class="loc-input" id="locIn" placeholder="City, State or ZIP code" autocomplete="off"><button class="loc-go" onclick="doSearch()">Search</button></div><div class="loc-results" id="locRes"></div></div></div></div>
<div class="ga" id="ga"><span>‚ö†</span><span id="gaTxt"></span></div>
<div class="dash">
  <div class="cd full"><div class="ch"><div class="ct">üå° Surface Conditions</div><a class="badge" id="srcSurf" href="#" target="_blank" rel="noopener">Open-Meteo GFS</a></div><div class="body" id="surfB"><div class="ldg"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div></div>
  <div class="cd full"><div class="ch tg open" onclick="tog(this)"><div class="ct">üìä Hourly Forecast<span class="sub">Next 24h</span></div><a class="badge" id="srcHr" href="#" target="_blank" rel="noopener" onclick="event.stopPropagation()">Open-Meteo GFS</a><span class="chv">‚ñæ</span></div><div class="body" id="hB"><div class="ldg"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div></div>
  <div class="full winds-pair">
    <div class="cd winds-micro"><div class="ch"><div class="ct">üî¨ Micro Winds<span class="sub">0‚Äì2000'</span></div><div class="badge" id="mvTime">Loading‚Ä¶</div></div><div class="body" id="microProfB"><div class="ldg"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div></div>
    <div class="cd winds-main"><div class="ch"><div class="ct">üéØ Winds Aloft<span class="sub" id="waSub">Loading...</span></div><div style="display:flex;gap:6px;align-items:center"><a class="badge" id="srcWA" href="#" target="_blank" rel="noopener">Open-Meteo GFS</a><div class="badge" id="wTime">Loading‚Ä¶</div></div></div><div class="body" id="profB"><div class="ldg"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div></div>
  </div>
  <div class="cd full"><div class="ch tg open" onclick="tog(this)"><div class="ct">üìù Area Forecast Discussion</div><a class="badge" id="afdT" href="#" target="_blank" rel="noopener" onclick="event.stopPropagation()">NWS</a><span class="chv" style="margin-left:auto;padding-left:10px">‚ñæ</span></div><div class="body" id="afdB"><div class="ldg"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div></div>
  <div class="cd"><div class="ch tg open" onclick="tog(this)"><div class="ct">üó∫ Wind Map</div><a class="badge" id="srcWindy" href="#" target="_blank" rel="noopener" onclick="event.stopPropagation()">Windy</a><span class="chv">‚ñæ</span></div><div class="body" style="padding:0"><iframe class="efr" id="windyFrame" loading="lazy"></iframe></div></div>
  <div class="cd"><div class="ch"><div class="ct">‚úàÔ∏è Aviation Briefing<span class="sub">TAFs ¬∑ SIGMETs ¬∑ AIRMETs ¬∑ PIREPs</span></div><a class="badge" id="srcAv" href="#" target="_blank" rel="noopener">aviationweather.gov</a></div><div class="body" id="avB"><div class="ldg"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div></div>
</div>
<script>
// ‚ïê‚ïê‚ïê CONFIG (dynamic + static) ‚ïê‚ïê‚ïê
const C={
  // Dynamic ‚Äî updated by setLocation()
  lat:33.57,lon:-117.13,elev:1349,name:'Temecula',locName:'French Valley',
  timezone:'America/Los_Angeles',nwsOffice:'SGX',
  stations:[
    {label:'F70',name:'French Valley',lat:33.57,lon:-117.13,dist:0},
    {label:'BNG',name:'Banning',lat:33.92,lon:-116.85,dist:30},
    {label:'CNO',name:'Chino',lat:33.97,lon:-117.64,dist:35},
    {label:'SBD',name:'San Bernardino',lat:34.10,lon:-117.24,dist:40},
    {label:'FUL',name:'Fullerton',lat:33.87,lon:-117.98,dist:42},
    {label:'SNA',name:'Santa Ana',lat:33.68,lon:-117.87,dist:45},
    {label:'SAN',name:'San Diego',lat:32.73,lon:-117.19,dist:50},
    {label:'ONT',name:'Ontario',lat:34.06,lon:-117.60,dist:55},
    {label:'PSP',name:'Palm Springs',lat:33.83,lon:-116.51,dist:60},
    {label:'LAX',name:'Los Angeles',lat:33.94,lon:-118.41,dist:95}
  ],
  metarStns:[{id:'KCRQ',nm:'Carlsbad',elev:331},{id:'KSAN',nm:'San Diego',elev:17},{id:'KONT',nm:'Ontario',elev:944},{id:'KSNA',nm:'Santa Ana',elev:56}],
  // Static
  levels:[{hPa:1000,msl:360},{hPa:975,msl:1050},{hPa:950,msl:1640},{hPa:925,msl:2625},{hPa:900,msl:3280},{hPa:875,msl:3940},{hPa:850,msl:4920},{hPa:825,msl:5580},{hPa:800,msl:6230},{hPa:775,msl:7220},{hPa:750,msl:8200},{hPa:700,msl:9840},{hPa:650,msl:11780},{hPa:600,msl:13800},{hPa:550,msl:15960},{hPa:500,msl:18290}],
  dispAlts:[1000,2000,3000,4000,5000,6000,7000,8000,9000,10000,11000,12000,13000,14000,15000,16000,17000,18000],gThr:10,
  kw:{'santa ana':{c:'ks',h:'hs0',l:'Santa Ana'},'offshore flow':{c:'ks',h:'hs0',l:'Offshore Flow'},'sundowner':{c:'ks',h:'hs0',l:'Sundowner'},'low pressure':{c:'kp',h:'hp0',l:'Low Pressure'},'trough':{c:'kp',h:'hp0',l:'Trough'},'cold front':{c:'kp',h:'hp0',l:'Cold Front'},'warm front':{c:'kp',h:'hp0',l:'Warm Front'},'marine layer':{c:'km',h:'hm0',l:'Marine Layer'},'onshore flow':{c:'km',h:'hm0',l:'Onshore Flow'},'catalina eddy':{c:'km',h:'hm0',l:'Catalina Eddy'},'fog':{c:'kf',h:'hf0',l:'Fog'},'low stratus':{c:'kf',h:'hf0',l:'Low Stratus'},'visibility':{c:'kf',h:'hf0',l:'Visibility'},'wind shear':{c:'kw',h:'hw0',l:'Wind Shear'},'gusty':{c:'kw',h:'hw0',l:'Gusty'},'gusts':{c:'kw',h:'hw0',l:'Gusts'},'breezy':{c:'kw',h:'hw0',l:'Breezy'},'wind advisory':{c:'kw',h:'hw0',l:'Wind Advisory'},'high wind':{c:'kw',h:'hw0',l:'High Wind'},'turbulence':{c:'kt',h:'ht0',l:'Turbulence'},'convection':{c:'kt',h:'ht0',l:'Convection'},'thunderstorm':{c:'kt',h:'ht0',l:'Thunderstorm'}}
};

// ‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê
const getTZ=()=>C.timezone||'America/Los_Angeles';
const cp=d=>{if(d==null||isNaN(d))return'‚Äî';return['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'][Math.round(d/22.5)%16]};
const wC=s=>s<5?'var(--calm)':s<10?'var(--mod)':s<15?'var(--strong)':'var(--danger)';
const wH=s=>s<5?'#34d399':s<10?'#fbbf24':s<15?'#fb923c':'#f87171';
const spC=s=>s<=3?'var(--danger)':s<=5?'var(--mod)':'var(--calm)';
const fT=iso=>new Date(iso).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true,timeZone:getTZ()});
const fH=iso=>new Date(iso).toLocaleTimeString('en-US',{hour:'numeric',hour12:true,timeZone:getTZ()});
const nI=t=>{const n=Date.now();let c=0,m=Infinity;t.forEach((v,i)=>{const d=Math.abs(new Date(v).getTime()-n);if(d<m){m=d;c=i}});return c};
const agl=msl=>msl-C.elev;
const pad3=d=>String(Math.round(((d%360)+360)%360)).padStart(3,'0');
const toD=d=>((Math.round(d)+180)%360);
const fDir=d=>d==null||isNaN(d)?'‚Äî':`To ${pad3(toD(d))} / From ${pad3(d)}`;
const fDirTF=d=>d==null||isNaN(d)?'‚Äî':`<div style="color:var(--tx2)">To ${cp(toD(d))} ${pad3(toD(d))}¬∞</div><div style="color:var(--tx4)">From ${cp(d)} ${pad3(d)}¬∞</div>`;

function vecArrow(dir, spd, maxSpd, color, cellW) {
  if(dir==null||spd==null) return '';
  const len = Math.max(8, (spd / maxSpd) * (cellW * 0.42));
  const goDir = ((dir||0) + 180) % 360;
  return `<svg width="${cellW}" height="40" viewBox="0 0 ${cellW} 40" style="overflow:visible">
    <g transform="translate(${cellW/2},20) rotate(${goDir})">
      <line x1="0" y1="${len/2}" x2="0" y2="${-len/2}" stroke="${color}" stroke-width="2.5" stroke-linecap="round"/>
      <polygon points="0,${-len/2-4} -4,${-len/2+4} 4,${-len/2+4}" fill="${color}"/>
    </g>
  </svg>`;
}
function smArrow(dir, col, sz) {
  if(dir==null) return '';
  const go = ((dir||0)+180)%360;
  return `<svg width="${sz}" height="${sz}" viewBox="0 0 24 24" style="display:block;margin:0 auto"><g transform="rotate(${go},12,12)"><line x1="12" y1="18" x2="12" y2="6" stroke="${col}" stroke-width="2.5" stroke-linecap="round"/><polygon points="12,4 8,10 16,10" fill="${col}"/></g></svg>`;
}

function tog(h){h.classList.toggle('open');const b=h.nextElementSibling;b.classList.toggle('hide');const f=b.querySelector('iframe[data-src]');if(f&&!f.src){void b.offsetHeight;f.src=f.dataset.src;f.removeAttribute('data-src')}}

// ‚ïê‚ïê‚ïê LOCATION SEARCH ‚ïê‚ïê‚ïê
function openLoc(){document.getElementById('locOv').classList.add('v');document.getElementById('locIn').focus();updateLocCur()}
function closeLoc(){document.getElementById('locOv').classList.remove('v');document.getElementById('locRes').innerHTML=''}
function updateLocCur(){document.getElementById('locCur').innerHTML=`Current: <span>${C.name}</span> ¬∑ ${C.lat.toFixed(2)}¬∞N ${Math.abs(C.lon).toFixed(2)}¬∞W ¬∑ ${Math.round(C.elev)} ft`}
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeLoc();if(e.key==='Enter'&&document.getElementById('locOv').classList.contains('v'))doSearch()});

async function doSearch(){
  const q=document.getElementById('locIn').value.trim();if(!q)return;
  const res=document.getElementById('locRes');
  res.innerHTML='<div class="loc-msg info">Searching...</div>';
  try{
    let results=[];
    if(/^\d{5}$/.test(q)){
      const r=await fetch(`https://api.zippopotam.us/us/${q}`);
      if(!r.ok)throw new Error('ZIP not found');
      const d=await r.json();const p=d.places?.[0];
      if(p)results=[{name:p['place name'],admin:d['country abbreviation']+', '+p['state abbreviation'],lat:parseFloat(p.latitude),lon:parseFloat(p.longitude),elevation:null,timezone:null,country:'US'}];
    }else{
      const r=await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=5&language=en&format=json`);
      if(!r.ok)throw new Error('Geocoding failed');
      const d=await r.json();
      results=(d.results||[]).map(r=>({name:r.name,admin:[r.admin1,r.country].filter(Boolean).join(', '),lat:r.latitude,lon:r.longitude,elevation:r.elevation,timezone:r.timezone,country:r.country_code}));
    }
    if(!results.length){res.innerHTML='<div class="loc-msg err">No results found. Try a different search.</div>';return}
    res.innerHTML='';
    results.forEach(r=>{
      const el=document.createElement('div');el.className='loc-item';
      el.innerHTML=`<div class="loc-item-name">${r.name}</div><div class="loc-item-sub">${r.admin} ¬∑ ${r.lat.toFixed(2)}¬∞N ${Math.abs(r.lon).toFixed(2)}¬∞W${r.elevation!=null?' ¬∑ '+Math.round(r.elevation*3.28084)+' ft':''}</div>`;
      el.onclick=()=>selectLocation(r);
      res.appendChild(el);
    });
  }catch(e){res.innerHTML=`<div class="loc-msg err">${e.message}</div>`}
}

async function selectLocation(geo){
  const res=document.getElementById('locRes');
  res.innerHTML='<div class="loc-msg info">Discovering nearby stations...</div>';
  try{
    // Get elevation if missing (ZIP lookups don't include it)
    let elev=geo.elevation!=null?Math.round(geo.elevation*3.28084):null;
    let tz=geo.timezone;
    let office='';
    // NWS points lookup
    try{
      const pr=await fetch(`https://api.weather.gov/points/${geo.lat.toFixed(4)},${geo.lon.toFixed(4)}`);
      if(pr.ok){const pd=await pr.json();
        office=(pd.properties?.forecastOffice||'').split('/').pop()||'';
        tz=tz||pd.properties?.timeZone||'America/New_York';
      }
    }catch(e){console.warn('NWS points:',e)}
    // Get elevation from Open-Meteo if still missing
    if(elev==null){try{
      const er=await fetch(`https://api.open-meteo.com/v1/elevation?latitude=${geo.lat}&longitude=${geo.lon}`);
      if(er.ok){const ed=await er.json();elev=ed.elevation?.[0]!=null?Math.round(ed.elevation[0]*3.28084):0}
    }catch(e){elev=0}}
    // Discover nearby stations ‚Äî query home point + offset points to cover adjacent forecast offices
    let metarStns=[],compStns=[];
    try{
      const parseStnFeatures=features=>features.filter(f=>f.properties).map(f=>{
        const p=f.properties;const c=f.geometry?.coordinates||[];
        return{id:p.stationIdentifier||'',name:p.name||'',lat:c[1],lon:c[0],elev:p.elevation?.value!=null?Math.round(p.elevation.value*3.28084):0};
      }).filter(s=>s.id&&s.id.length===4&&s.id.startsWith('K'));
      // Fetch stations from home point + 4 offset points (~0.7¬∞ in each direction) to span multiple NWS offices
      const offsets=[[0,0],[0.6,0],[-0.6,0],[0,0.7],[0,-0.7]];
      const stnFetches=offsets.map(([dLat,dLon])=>
        fetch(`https://api.weather.gov/points/${(geo.lat+dLat).toFixed(4)},${(geo.lon+dLon).toFixed(4)}/stations`)
          .then(r=>r.ok?r.json():{features:[]}).catch(()=>({features:[]}))
      );
      const stnResults=await Promise.all(stnFetches);
      // Merge and deduplicate all stations
      const seenIds=new Set();const allStns=[];
      stnResults.forEach(sd=>{
        const features=sd.features||sd.observationStations||[];
        parseStnFeatures(features).forEach(s=>{if(!seenIds.has(s.id)){seenIds.add(s.id);allStns.push(s)}});
      });
      // Distance helper
      const R=3959;const toRad=d=>d*Math.PI/180;
      const dist=(a,b)=>{const dLat=toRad(b.lat-a.lat),dLon=toRad(b.lon-a.lon);const x=Math.sin(dLat/2)**2+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLon/2)**2;return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x))};
      const home={lat:geo.lat,lon:geo.lon};
      const withDist=allStns.map(s=>({...s,d:dist(home,s)})).sort((a,b)=>a.d-b.d);
      // Closest 4 for METAR
      metarStns=withDist.slice(0,4).map(s=>({id:s.id,nm:s.name.split(',')[0].trim(),elev:s.elev}));
      // Pick up to 10 stations spread across distance bands for broad coverage
      const bands=[5,12,20,30,40,55,70,90,115,140],picked=new Set();
      bands.forEach(minD=>{
        const matches=withDist.filter(s=>s.d>=minD&&s.d<minD+20&&!picked.has(s.id));
        matches.slice(0,2).forEach(s=>{
          if(picked.size<10){picked.add(s.id);compStns.push({label:s.id.replace(/^K/,''),name:s.name.split(',')[0].trim(),lat:s.lat,lon:s.lon,dist:Math.round(s.d)})}
        });
      });
    }catch(e){console.warn('Stations:',e)}
    // Build stations array
    const homeLabel=geo.name.substring(0,4).toUpperCase();
    const stations=[{label:homeLabel,name:geo.name,lat:geo.lat,lon:geo.lon,dist:0},...compStns];
    // Apply to config
    C.lat=geo.lat;C.lon=geo.lon;C.elev=elev;C.name=geo.name;C.locName=geo.name;
    C.timezone=tz||'America/New_York';C.nwsOffice=office;
    C.stations=stations;
    C.metarStns=metarStns.length?metarStns:[];
    // Update UI
    updateUI();
    // Save to localStorage
    try{localStorage.setItem('balloonWeatherLoc',JSON.stringify({cfgVer:CFG_VER,lat:C.lat,lon:C.lon,elev:C.elev,name:C.name,locName:C.locName,timezone:C.timezone,nwsOffice:C.nwsOffice,stations:C.stations,metarStns:C.metarStns}))}catch(e){}
    closeLoc();
    refreshAll();
  }catch(e){res.innerHTML=`<div class="loc-msg err">Error: ${e.message}</div>`}
}

function updateUI(){
  document.title=C.name+' Balloon Weather';
  document.getElementById('hdrTitle').textContent=C.name+' Balloon Weather';
  document.getElementById('hdrSub').textContent=`${C.locName} ¬∑ ${C.lat.toFixed(2)}¬∞N ${Math.abs(C.lon).toFixed(2)}¬∞W ¬∑ ${Math.round(C.elev).toLocaleString()} ft`;
  document.getElementById('waSub').textContent=C.stations.length+' stations ¬∑ scroll ‚Üí';
  if(C.nwsOffice){const afdEl=document.getElementById('afdT');afdEl.textContent='NWS '+C.nwsOffice;afdEl.href=`https://forecast.weather.gov/product.php?site=${C.nwsOffice.toLowerCase()}&issuedby=${C.nwsOffice}&product=AFD`}
  // Update source badge links (location-specific)
  const omUrl=`https://open-meteo.com/en/docs/gfs-api#latitude=${C.lat}&longitude=${C.lon}&hourly=temperature_2m,wind_speed_10m,wind_gusts_10m&wind_speed_unit=mph&temperature_unit=fahrenheit`;
  document.getElementById('srcSurf').href=omUrl;
  document.getElementById('srcWA').href=omUrl;
  document.getElementById('srcHr').href=omUrl;
  document.getElementById('srcWindy').href=`https://www.windy.com/?${C.lat},${C.lon},9,wind`;
  const metarIds=C.metarStns.map(s=>s.id).join(',');
  document.getElementById('srcAv').href=`https://aviationweather.gov/data/taf/?id=${metarIds}`;
  // Update iframe URLs
  const wf=document.getElementById('windyFrame');
  const wUrl=`https://embed.windy.com/embed.html?type=map&location=coordinates&metricRain=default&metricTemp=%C2%B0F&metricWind=mph&zoom=9&overlay=wind&product=ecmwf&level=surface&lat=${C.lat}&lon=${C.lon}`;
  if(wf.src)wf.src=wUrl;else wf.dataset.src=wUrl;
}

// ‚ïê‚ïê‚ïê DATA FETCH ‚ïê‚ïê‚ïê
function omUrl(lat,lon){
  const pv=[];C.levels.forEach(l=>{pv.push(`wind_speed_${l.hPa}hPa`,`wind_direction_${l.hPa}hPa`,`temperature_${l.hPa}hPa`,`geopotential_height_${l.hPa}hPa`)});
  const sv=['temperature_2m','dew_point_2m','relative_humidity_2m','wind_speed_10m','wind_direction_10m','wind_gusts_10m','cloud_cover','visibility','precipitation_probability','surface_pressure'];
  return`https://api.open-meteo.com/v1/gfs?latitude=${lat}&longitude=${lon}&hourly=${[...sv,...pv].join(',')}&wind_speed_unit=mph&temperature_unit=fahrenheit&forecast_days=2&timezone=${encodeURIComponent(getTZ())}&models=gfs_seamless`;
}
async function fetchOM(a,b){const r=await fetch(omUrl(a,b));if(!r.ok)throw new Error('Open-Meteo '+r.status);return r.json()}
async function fetchAFD(){
  if(!C.nwsOffice)throw new Error('No NWS office');
  const lr=await fetch(`https://api.weather.gov/products/types/AFD/locations/${C.nwsOffice}`);if(!lr.ok)throw new Error('AFD '+lr.status);
  const ld=await lr.json();const id=ld['@graph']?.[0]?.id;if(!id)throw new Error('No AFD');
  const pr=await fetch(`https://api.weather.gov/products/${id}`);if(!pr.ok)throw new Error('AFD '+pr.status);
  const pd=await pr.json();return{text:pd.productText,time:pd.issuanceTime};
}
async function fetchMETARs(){const results={};if(!C.metarStns.length)return results;await Promise.all(C.metarStns.map(async stn=>{try{const r=await fetch(`https://api.weather.gov/stations/${stn.id}/observations/latest`,{headers:{'Accept':'application/geo+json','User-Agent':'BalloonWeather/1.0'}});if(!r.ok)return;const d=await r.json();results[stn.id]={name:stn.nm,elev:stn.elev,layers:d.properties?.cloudLayers||[],raw:d.properties?.rawMessage||'',time:d.properties?.timestamp}}catch(e){console.warn('METAR',stn.id,e)}}));return results}

// ‚ïê‚ïê‚ïê AVIATION BRIEFING FETCHES ‚ïê‚ïê‚ïê
async function fetchTAFs(){
  const results={};if(!C.metarStns.length)return results;
  try{
    const ids=C.metarStns.map(s=>s.id).join(',');
    const r=await fetch(`https://aviationweather.gov/api/data/taf?ids=${ids}&format=json`);
    if(!r.ok)throw new Error('TAF '+r.status);
    const d=await r.json();
    // Handle both array and wrapped formats
    const arr=Array.isArray(d)?d:(d.TAFs||d.data||d.taf||[]);
    arr.forEach(t=>{
      const id=t.icaoId||t.stationId||t.station||'';
      if(id)results[id]={raw:t.rawTAF||t.rawText||t.raw||'',issueTime:t.issueTime||t.bulletinTime||'',validFrom:t.validTimeFrom||t.validFrom||'',validTo:t.validTimeTo||t.validTo||''};
    });
  }catch(e){console.warn('TAF:',e)}
  return results;
}

async function fetchAirSigmet(){
  try{
    const r=await fetch('https://aviationweather.gov/api/data/airsigmet?format=json');
    if(!r.ok)throw new Error('AIRSIGMET '+r.status);
    const d=await r.json();
    const arr=Array.isArray(d)?d:(d.data||[]);
    return arr;
  }catch(e){console.warn('AIRSIGMET:',e);return[]}
}

async function fetchPIREPs(){
  try{
    const r=await fetch(`https://aviationweather.gov/api/data/pirep?lat=${C.lat}&lon=${C.lon}&dist=100&format=json`);
    if(!r.ok)throw new Error('PIREP '+r.status);
    const d=await r.json();
    return Array.isArray(d)?d:(d.data||d.PIREPs||[]);
  }catch(e){console.warn('PIREP:',e);return[]}
}

// ‚ïê‚ïê‚ïê SURFACE ‚ïê‚ïê‚ïê
let _allStnData=null; // stored by refreshAll for surface comparison
function rSurf(d,metars){
  const el=document.getElementById('surfB'),h=d.hourly,i=nI(h.time);
  const tmp=h.temperature_2m?.[i],dew=h.dew_point_2m?.[i],spr=(tmp!=null&&dew!=null)?(tmp-dew).toFixed(1):null;
  const wnd=h.wind_speed_10m?.[i],gst=h.wind_gusts_10m?.[i],wdr=h.wind_direction_10m?.[i];
  const cld=h.cloud_cover?.[i],vis=h.visibility?.[i],viMi=vis!=null?(vis/1609.34).toFixed(1):null;
  const prc=h.precipitation_probability?.[i],prs=h.surface_pressure?.[i],inhg=prs!=null?(prs*0.02953).toFixed(2):null;
  chkG(h,i);
  const wndCol=wnd!=null?wH(wnd):'#5a6680';
  let ticks='';for(let a=0;a<360;a+=30){ticks+=`<div class="ctick" style="transform:rotate(${a}deg) translateX(-0.5px)"></div>`}
  let o=`<div class="cw"><div style="text-align:center">
    <div class="cbox"><div class="cring">${ticks}
      <span class="clbl n">N</span><span class="clbl s">S</span><span class="clbl e">E</span><span class="clbl w">W</span>
      <svg class="cneedle" width="210" height="210" viewBox="0 0 210 210" style="position:absolute;top:0;left:0;transform:rotate(${wdr!=null?(wdr+180)%360:0}deg)">
        <defs><linearGradient id="ng" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${wndCol}"/><stop offset="100%" stop-color="transparent"/></linearGradient></defs>
        <line x1="105" y1="105" x2="105" y2="${105 - Math.min(30 + (wnd||0)*3, 88)}" stroke="url(#ng)" stroke-width="3" stroke-linecap="round"/>
        <polygon points="105,${105 - Math.min(30 + (wnd||0)*3, 88) - 4} 101,${105 - Math.min(30 + (wnd||0)*3, 88) + 5} 109,${105 - Math.min(30 + (wnd||0)*3, 88) + 5}" fill="${wndCol}"/>
      </svg>
      <div class="cdot"></div>
    </div></div>
    <div class="cspeed"><div class="big" style="color:${wnd!=null?wC(wnd):'var(--tx)'}">${wnd!=null?Math.round(wnd):'‚Äî'}<span class="unit">mph</span></div>
    <div class="dir">${wdr!=null?fDir(wdr):'‚Äî'}</div>
    ${gst!=null&&gst>=C.gThr?`<div style="color:var(--gust);font-size:13px;margin-top:4px;font-weight:600">Gusts ${Math.round(gst)} mph</div>`:gst!=null?`<div style="color:var(--tx3);font-size:12px;margin-top:4px">Gusts ${Math.round(gst)} mph</div>`:''}</div>
  </div>`;
  const sprPct=spr!=null?Math.min((spr/15)*100,100):0;
  const cBase=(tmp!=null&&dew!=null)?Math.round(((tmp-dew)/4.4)*1000):null;const cBStr=cBase!=null?(cBase>=1000?(cBase/1000).toFixed(1)+'k ft AGL':cBase+' ft AGL'):'‚Äî';
  o+=`<div class="stats">
    <div class="stat"><div><div class="stat-lbl">Temperature</div><div class="stat-sub">Dew ${dew!=null?Math.round(dew):'‚Äî'}¬∞F</div></div><div class="stat-val">${tmp!=null?Math.round(tmp):'‚Äî'}¬∞F</div></div>
    <div class="stat"><div style="flex:1"><div style="display:flex;justify-content:space-between"><div class="stat-lbl">Temp/Dew Spread ${spr!=null&&spr<=3?'<span style="color:var(--danger)">‚ö† Fog</span>':spr!=null&&spr<=5?'<span style="color:var(--mod)">Watch</span>':''}</div><div class="stat-val" style="color:${spr!=null?spC(spr):'inherit'}">${spr??'‚Äî'}¬∞F</div></div><div class="gauge"><div class="gauge-fill" style="width:${sprPct}%;background:${spr!=null?spC(spr):'var(--tx3)'}"></div></div></div></div>
    <div class="stat"><div class="stat-lbl">Est. Cloud Base <span style="font-size:9px;color:var(--tx4)">(LCL)</span></div><div class="stat-val">${cBStr}</div></div>
    <div class="stat"><div style="flex:1"><div style="display:flex;justify-content:space-between"><div class="stat-lbl">Cloud Cover</div><div class="stat-val">${cld!=null?Math.round(cld):'‚Äî'}%</div></div><div class="gauge"><div class="gauge-fill" style="width:${cld??0}%;background:var(--tx3)"></div></div></div></div>
    <div class="stat"><div class="stat-lbl">Visibility</div><div class="stat-val">${viMi??'‚Äî'} mi</div></div>
    <div class="stat"><div class="stat-lbl">Precip Chance</div><div class="stat-val">${prc!=null?Math.round(prc):'‚Äî'}%</div></div>
    <div class="stat"><div class="stat-lbl">Pressure</div><div class="stat-val">${inhg??'‚Äî'} inHg</div></div>
  </div></div>`;
  if(metars&&Object.keys(metars).length){
    const ceilCls={CLR:'clr',SKC:'clr',FEW:'few',SCT:'sct',BKN:'bkn',OVC:'ovc'};
    let loCeil=null,loStn=null;
    const metarUrl=`https://aviationweather.gov/data/metar/?id=${C.metarStns.map(s=>s.id).join(',')}`;
    o+=`<div class="ceil-wrap"><div class="ceil-lbl">‚òÅ Reported Cloud Layers <a href="${metarUrl}" target="_blank" rel="noopener" style="font-weight:400;color:var(--blue);letter-spacing:0;text-transform:none;font-size:9px;text-decoration:none;background:rgba(56,189,248,.1);padding:1px 6px;border-radius:8px">METAR ‚Üó</a></div>`;
    for(const[id,m]of Object.entries(metars)){
      o+=`<div class="ceil-stn"><span class="ceil-id">${id}</span><span class="ceil-nm">${m.name}</span><div class="ceil-layers">`;
      const valid=m.layers.filter(l=>l.amount&&l.amount!=='CLR'&&l.amount!=='SKC');
      if(!valid.length){o+=`<span class="ceil-layer clr">CLR</span>`}
      else{valid.forEach(l=>{
        const bM=l.base?.value;const bFt=bM!=null?Math.round(bM*3.28084):null;
        const bS=bFt!=null?(bFt>=1000?(bFt/1000).toFixed(1)+'k':bFt+"'"):'';
        const cls=ceilCls[l.amount]||'';
        o+=`<span class="ceil-layer ${cls}">${l.amount} ${bS}</span>`;
        if((l.amount==='BKN'||l.amount==='OVC')&&bFt!=null){if(!loCeil||bFt<loCeil){loCeil=bFt;loStn=id}}
      })}
      o+=`</div></div>`;
    }
    if(loCeil!=null){
      const cs=loCeil>=1000?(loCeil/1000).toFixed(1)+'k':loCeil;
      o+=`<div style="margin-top:8px;padding:6px 10px;background:var(--card2);border-radius:var(--rs);font-size:11px;font-family:'JetBrains Mono',monospace;display:flex;align-items:center;gap:8px"><span style="color:var(--tx3)">Lowest ceiling:</span><span style="color:${loCeil<2000?'var(--danger)':loCeil<5000?'var(--mod)':'var(--calm)'};font-weight:700">${cs} ft AGL</span><span style="color:var(--tx4)">@ ${loStn}</span></div>`;
    }
    o+=`</div>`;
  }
  // ‚ïê‚ïê‚ïê SURFACE CONDITIONS COMPARISON (inline) ‚ïê‚ïê‚ïê
  if(_allStnData){
    const sources=C.stations.map(s=>({label:s.label,name:s.name,dist:s.dist||0,data:_allStnData[s.label]})).filter(s=>s.data&&s.data.hourly);
    if(sources.length>=2){
      o+='<div class="sc-wrap"><div class="sc-title">üìç Conditions at Nearby Stations <span style="font-weight:400;text-transform:none;letter-spacing:0;font-size:9px;color:var(--tx4)">scroll ‚Üí</span></div>';
      o+='<div class="sc-scroll"><div class="sc-grid">';
      // Header row
      o+='<div class="sc-row sc-hdr"><div class="sc-lbl"></div>';
      sources.forEach((src,si)=>{
        o+=`<div class="sc-cell"${si>0?' style="border-left:1px solid rgba(30,41,59,.3)"':''}>`;
        o+=`<div style="font-size:10px;font-weight:700;color:${si===0?'var(--blue)':'var(--tx)'}">${src.label}</div>`;
        o+=`<div style="font-size:7px;color:var(--tx4);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%">${src.name}</div>`;
        o+=src.dist>0?`<div class="vf-dist">${src.dist} mi</div>`:`<div class="vf-dist" style="color:var(--blue)">Home</div>`;
        o+='</div>';
      });
      o+='</div>';
      // Data rows
      const scRows=[
        {lbl:'Temp',fn:(h,ci)=>{const v=h.temperature_2m?.[ci];return v!=null?`<span>${Math.round(v)}¬∞F</span>`:'‚Äî'}},
        {lbl:'Dew Pt',fn:(h,ci)=>{const v=h.dew_point_2m?.[ci];return v!=null?`<span style="color:var(--tx2)">${Math.round(v)}¬∞F</span>`:'‚Äî'}},
        {lbl:'Spread',fn:(h,ci)=>{const t=h.temperature_2m?.[ci],d=h.dew_point_2m?.[ci];if(t==null||d==null)return'‚Äî';const sp=(t-d).toFixed(1);return`<span style="color:${spC(parseFloat(sp))}">${sp}¬∞</span>`}},
        {lbl:'Wind',fn:(h,ci)=>{const s=h.wind_speed_10m?.[ci],d=h.wind_direction_10m?.[ci];if(s==null)return'‚Äî';return`<span style="color:${wC(s)}">${Math.round(s)}</span><span style="font-size:9px;color:var(--tx3);font-weight:400"> ${d!=null?cp(d):''}</span>`}},
        {lbl:'Gusts',fn:(h,ci)=>{const g=h.wind_gusts_10m?.[ci];if(g==null)return'<span style="color:var(--tx4)">‚Äî</span>';return`<span style="color:${g>=C.gThr?'var(--gust)':'var(--tx2)'}">${Math.round(g)} mph</span>`}},
        {lbl:'Cloud Base',fn:(h,ci)=>{const t=h.temperature_2m?.[ci],d=h.dew_point_2m?.[ci];if(t==null||d==null)return'‚Äî';const cb=Math.round(((t-d)/4.4)*1000);return cb>=1000?`${(cb/1000).toFixed(1)}k'`:`${cb}'`}},
        {lbl:'Cloud %',fn:(h,ci)=>{const v=h.cloud_cover?.[ci];return v!=null?`${Math.round(v)}%`:'‚Äî'}},
        {lbl:'Visibility',fn:(h,ci)=>{const v=h.visibility?.[ci];return v!=null?`${(v/1609.34).toFixed(1)} mi`:'‚Äî'}},
        {lbl:'Precip %',fn:(h,ci)=>{const v=h.precipitation_probability?.[ci];if(v==null)return'‚Äî';return v>0?`<span style="color:var(--blue)">${Math.round(v)}%</span>`:`<span style="color:var(--tx4)">0%</span>`}},
        {lbl:'Pressure',fn:(h,ci)=>{const v=h.surface_pressure?.[ci];return v!=null?`${(v*0.02953).toFixed(2)}`:'‚Äî'}},
      ];
      scRows.forEach((row,ri)=>{
        o+=`<div class="sc-row"${ri%2===0?' style="background:rgba(15,21,37,.4)"':''}>`;
        o+=`<div class="sc-lbl">${row.lbl}</div>`;
        sources.forEach((src,si)=>{
          const sh=src.data.hourly,sci=nI(sh.time);
          o+=`<div class="sc-cell"${si>0?' style="border-left:1px solid rgba(30,41,59,.15)"':''}>${row.fn(sh,sci)}</div>`;
        });
        o+='</div>';
      });
      o+='</div></div>';
      if(sources.length>3){o+=`<div style="text-align:center;padding:4px 0"><span style="font-size:9px;color:var(--tx4);font-family:'JetBrains Mono',monospace">‚Üê Scroll for ${sources.length} stations ‚Üí</span></div>`}
      o+='</div>';
    }
  }
  el.innerHTML=o;
}
function chkG(h,ci){const el=document.getElementById('ga'),tx=document.getElementById('gaTxt'),a=[];for(let i=ci;i<Math.min(ci+12,h.wind_gusts_10m.length);i++){const g=h.wind_gusts_10m[i];if(g!=null&&g>=C.gThr)a.push({t:h.time[i],g:Math.round(g)})}if(a.length){el.classList.add('v');tx.textContent=`Gusts up to ${Math.max(...a.map(x=>x.g))} mph ‚Äî first at ${fT(a[0].t)}, ${a.length} hr(s) in next 12h`}else el.classList.remove('v')}

// ‚ïê‚ïê‚ïê WIND SHEAR DETECTION ‚ïê‚ïê‚ïê
function detectShear(w1,w2){
  if(!w1||!w2||w1.spd==null||w2.spd==null||w1.dir==null||w2.dir==null)return null;
  const spdD=Math.abs(w2.spd-w1.spd);
  const raw=Math.abs(w2.dir-w1.dir);
  const dirD=Math.min(raw,360-raw);
  if(spdD>=10||dirD>=30){
    const sev=(spdD>=15||dirD>=45)?'strong':'moderate';
    return{spdDelta:Math.round(spdD),dirDelta:Math.round(dirD),severity:sev}
  }
  return null;
}

// ‚ïê‚ïê‚ïê MICRO WINDS ALOFT (0‚Äì2000' AGL, 100' steps) ‚ïê‚ïê‚ïê
function rMicroProfile(allData){
  const el=document.getElementById('microProfB'),tl=document.getElementById('mvTime');
  const homeKey=C.stations[0].label,homeD=allData[homeKey];
  if(!homeD||!homeD.hourly){el.innerHTML='<div class="err">No micro wind data</div>';return}
  const h=homeD.hourly,ci=nI(h.time);
  tl.textContent=fT(h.time[ci]);
  // Build wind data for 0-2000 AGL
  const rows=[];
  for(let ag=0;ag<=2000;ag+=100){
    let w;
    if(ag===0){
      const s=h.wind_speed_10m?.[ci],d=h.wind_direction_10m?.[ci];
      w=(s!=null&&d!=null)?{spd:s,dir:d}:null;
    }else{
      w=interpAt(h,ci,ag+C.elev);
    }
    rows.push({agl:ag,msl:ag+C.elev,wind:w});
  }
  // Find max speed for arrow scaling
  let maxSpd=10;
  rows.forEach(r=>{if(r.wind&&r.wind.spd>maxSpd)maxSpd=r.wind.spd});
  const cellW=36;
  let o='<div class="mvf-scroll"><div class="mvf-wrap">';
  // Render rows ascending (0 ‚Üí 2000)
  let prevW=null;
  for(let ri=0;ri<rows.length;ri++){
    const r=rows[ri];
    const spd=r.wind?.spd??null,dir=r.wind?.dir??null;
    const col=spd!=null?wH(spd):'#3d4a60';
    const dirLbl=dir!=null?`‚Üí${pad3(toD(dir))}¬∞`:'‚Äî';
    const agLbl=r.agl===0?'Sfc':`${r.agl}'`;
    const mslLbl=r.msl>=1000?(r.msl/1000).toFixed(1)+'k':r.msl+"'";
    // Shear bar (between this row and the one below)
    if(prevW&&r.wind){
      const sh=detectShear(prevW,r.wind);
      if(sh){
        o+=`<div class="mvf-row mvf-shear${sh.severity==='strong'?' strong':''}">`;
        o+=`<div class="mvf-alt">‚ö†</div>`;
        o+=`<div class="mvf-cell">Œî${sh.spdDelta} mph${sh.dirDelta>=10?' / '+sh.dirDelta+'¬∞':''}</div>`;
        o+=`</div>`;
      }
    }
    // Data row
    const bg=r.agl%500===0&&r.agl>0?' style="background:rgba(56,189,248,.03)"':r.agl===0?' style="background:rgba(52,211,153,.06)"':'';
    o+=`<div class="mvf-row"${bg}>`;
    o+=`<div class="mvf-alt">${agLbl}<span class="msl">${mslLbl} MSL</span></div>`;
    o+=`<div class="mvf-cell">`;
    o+=vecArrow(dir,spd,maxSpd,col,cellW);
    o+=`<div style="font-family:'JetBrains Mono',monospace;white-space:nowrap;min-width:0">`;
    o+=`<span style="color:${spd!=null?wC(spd):'var(--tx3)'};font-weight:700;font-size:12px">${spd!=null?Math.round(spd):'‚Äî'}<span style="font-size:8px;font-weight:400;color:var(--tx3)"> mph</span></span>`;
    o+=`<span style="font-size:8px;color:var(--tx2);margin-left:6px">${dirLbl}</span>`;
    o+=`</div></div>`;
    o+=`</div>`;
    prevW=r.wind;
  }
  o+='</div></div>';
  el.innerHTML=o;
}

// Interpolate wind data at a target MSL altitude between pressure levels
function interpAt(h,ti,tMSL){const pts=[];C.levels.forEach(l=>{const s=h[`wind_speed_${l.hPa}hPa`]?.[ti],d=h[`wind_direction_${l.hPa}hPa`]?.[ti],t=h[`temperature_${l.hPa}hPa`]?.[ti];if(s!=null&&d!=null)pts.push({msl:l.msl,spd:s,dir:d,tmp:t})});pts.sort((a,b)=>a.msl-b.msl);let lo=null,hi=null;for(let i=0;i<pts.length-1;i++){if(pts[i].msl<=tMSL&&pts[i+1].msl>=tMSL){lo=pts[i];hi=pts[i+1];break}}if(!lo||!hi)return null;const f=(tMSL-lo.msl)/(hi.msl-lo.msl);const spd=lo.spd+f*(hi.spd-lo.spd);const lr=lo.dir*Math.PI/180,hr=hi.dir*Math.PI/180;const u=Math.sin(lr)*(1-f)+Math.sin(hr)*f,v=Math.cos(lr)*(1-f)+Math.cos(hr)*f;const dir=((Math.atan2(u,v)*180/Math.PI)+360)%360;const tmp=(lo.tmp!=null&&hi.tmp!=null)?lo.tmp+f*(hi.tmp-lo.tmp):null;return{spd,dir,tmp}}

// ‚ïê‚ïê‚ïê WIND PROFILE ‚Äî VECTOR FIELD (MULTI-SOURCE) ‚ïê‚ïê‚ïê
function rProfile(allData){
  const el=document.getElementById('profB'),tl=document.getElementById('wTime');
  // Filter to only stations with successful data
  const sources=C.stations.map(s=>({key:s.label,label:s.label,sub:s.name,dist:s.dist||0,data:allData[s.label]})).filter(s=>s.data&&s.data.hourly);
  if(!sources.length){el.innerHTML='<div class="err">No wind data available</div>';return}
  const homeH=sources[0].data.hourly,ci=nI(homeH.time);
  tl.textContent=fT(homeH.time[ci]);
  let maxSpd=15;
  const allLvl=C.levels.filter(l=>agl(l.msl)>=0);
  sources.forEach(src=>{const h=src.data.hourly,si=nI(h.time);allLvl.forEach(l=>{const s=h[`wind_speed_${l.hPa}hPa`]?.[si]||0;if(s>maxSpd)maxSpd=s})});
  const cellW=48;
  let o='<div class="vf-scroll"><div class="vf-wrap">';
  // Header row
  o+='<div class="vf-row vf-hdr"><div class="vf-alt"></div>';
  sources.forEach((src,i)=>{
    o+=`<div class="vf-cell" style="height:auto;border:none;flex-direction:column;gap:1px;padding:6px 4px${i>0?';border-left:1px solid rgba(30,41,59,.3)':''}">`;
    o+=`<div style="font-size:11px;font-weight:700;color:${i===0?'var(--blue)':'var(--tx)'};font-family:'JetBrains Mono',monospace">${src.label}</div>`;
    o+=`<div style="font-size:8px;color:var(--tx4);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%">${src.sub}</div>`;
    o+=src.dist>0?`<div class="vf-dist">${src.dist} mi</div>`:`<div class="vf-dist" style="color:var(--blue)">Home</div>`;
    o+='</div>';
  });
  o+='</div>';
  // Data rows ‚Äî one per altitude, with shear detection
  let prevHomeW=null;
  C.dispAlts.forEach(ag=>{
    const msl=ag+C.elev,al=(ag/1000)+'k',ml=(msl/1000).toFixed(1)+'k';
    // Get home station wind for shear check
    const homeW=interpAt(homeH,ci,msl);
    // Insert shear bar between this row and the previous
    if(prevHomeW&&homeW){
      const sh=detectShear(prevHomeW,homeW);
      if(sh){
        o+=`<div class="vf-row vf-shear${sh.severity==='strong'?' strong':''}">`;
        o+=`<div class="vf-alt">‚ö† shear</div>`;
        sources.forEach((src,si)=>{
          if(si===0){o+=`<div class="vf-cell">‚ö° Œî${sh.spdDelta} mph${sh.dirDelta>=10?' / '+sh.dirDelta+'¬∞':''}</div>`}
          else{o+=`<div class="vf-cell" style="border-left:1px solid rgba(30,41,59,.15)"></div>`}
        });
        o+=`</div>`;
      }
    }
    prevHomeW=homeW;
    o+='<div class="vf-row">';
    o+=`<div class="vf-alt">${al} ft<span class="msl">${ml} MSL</span></div>`;
    sources.forEach((src,i)=>{
      const h=src.data.hourly,si=nI(h.time);
      const w=interpAt(h,si,msl);const spd=w?.spd??null,dir=w?.dir??null;
      const col=spd!=null?wH(spd):'#3d4a60';
      const dirLabel=dir!=null?`‚Üí${pad3(toD(dir))}¬∞`:'‚Äî';
      o+=`<div class="vf-cell"${i>0?' style="border-left:1px solid rgba(30,41,59,.3)"':''}>`;
      o+=vecArrow(dir,spd,maxSpd,col,cellW);
      o+=`<div style="font-family:'JetBrains Mono',monospace;white-space:nowrap;text-align:left;min-width:0">`;
      o+=`<div style="color:${spd!=null?wC(spd):'var(--tx3)'};font-weight:700;font-size:13px">${spd!=null?Math.round(spd):'‚Äî'}<span style="font-size:9px;font-weight:400;color:var(--tx3)"> mph</span></div>`;
      o+=`<div style="font-size:9px;color:var(--tx2)">${dirLabel}</div>`;
      o+=`</div></div>`;
    });
    o+='</div>';
  });
  o+='</div></div>';
  if(sources.length>3){o+=`<div style="text-align:center;padding:4px 0"><span style="font-size:9px;color:var(--tx4);font-family:'JetBrains Mono',monospace">‚Üê Scroll for ${sources.length} stations ‚Üí</span></div>`}
  const homeLbl=C.stations[0].label;
  o+=`<div style="text-align:center;margin-top:8px"><button class="atog" onclick="this.nextElementSibling.classList.toggle('hide');this.textContent=this.nextElementSibling.classList.contains('hide')?'Show ${homeLbl} 6-Hour Data Table':'Hide Data Table'" style="width:auto;display:inline-block;padding:5px 16px">Show ${homeLbl} 6-Hour Data Table</button>`;
  const hrs=[];for(let i=ci;i<Math.min(ci+6,homeH.time.length);i++)hrs.push(i);
  o+=`<div class="hide"><table class="dtable"><thead><tr><th>Alt</th>`;hrs.forEach((hi,j)=>o+=`<th>${j===0?'Now':fH(homeH.time[hi])}</th>`);o+=`</tr></thead><tbody>`;
  C.dispAlts.forEach(ag=>{const msl=ag+C.elev,al=(ag/1000)+'k ft';
    o+=`<tr><td style="color:var(--tx2)">${al}</td>`;
    hrs.forEach(hi=>{const w=interpAt(homeH,hi,msl);const spd=w?.spd??null,dir=w?.dir??null,tmp=w?.tmp??null,col=spd!=null?wC(spd):'var(--tx3)';
      o+=`<td><span style="color:${col};font-weight:600">${spd!=null?Math.round(spd):'‚Äî'}</span> <span style="color:var(--tx3);font-size:9px">${fDir(dir)}</span>${tmp!=null?` <span style="font-size:9px;color:var(--tx4)">${Math.round(tmp)}¬∞F</span>`:''}</td>`;
    });o+='</tr>';});
  o+=`</tbody></table></div></div>`;
  el.innerHTML=o;
}

// ‚ïê‚ïê‚ïê HOURLY ‚ïê‚ïê‚ïê
let _hourlyData=null;
function rHourly(d){
  _hourlyData=d;
  const el=document.getElementById('hB'),h=d.hourly,ci=nI(h.time);let o='<div class="hstrip">';
  for(let i=ci;i<Math.min(ci+24,h.time.length);i++){
    const tmp=h.temperature_2m?.[i],dew=h.dew_point_2m?.[i],wnd=h.wind_speed_10m?.[i],gst=h.wind_gusts_10m?.[i],wdr=h.wind_direction_10m?.[i],cld=h.cloud_cover?.[i],prc=h.precipitation_probability?.[i],gy=gst!=null&&gst>=C.gThr;
    const col=wnd!=null?wH(wnd):'#3d4a60';
    const cBase=(tmp!=null&&dew!=null)?Math.round(((tmp-dew)/4.4)*1000):null;const cBFmt=cBase!=null?(cBase>=1000?(cBase/1000).toFixed(1)+'k':cBase+'\''):'‚Äî';
    o+=`<div class="hcol${gy?' gy':''}" data-hi="${i}" onclick="showHourDet(this,${i})"><div class="htime">${i===ci?'Now':fH(h.time[i])}</div><div class="htemp">${tmp!=null?Math.round(tmp):'‚Äî'}¬∞</div>
      ${prc!=null&&prc>0?`<div class="hprc">${Math.round(prc)}%</div>`:''}
      ${smArrow(wdr,col,22)}
      <div class="hspd" style="color:${wnd!=null?wC(wnd):'var(--tx3)'}">${wnd!=null?Math.round(wnd):'‚Äî'}</div>
      ${gy?`<div class="hgust">G${Math.round(gst)}</div>`:''}<div class="hdir">${wdr!=null?'‚Üí'+pad3(toD(wdr))+' ‚Üê'+pad3(wdr):'‚Äî'}</div>
      <div class="hcb">‚òÅ${cBFmt}</div>
      <div class="hcbar"><div class="hcfill" style="width:${cld??0}%"></div></div></div>`;
  }
  o+='</div><div class="hdet" id="hDet"></div>';el.innerHTML=o;
}
function showHourDet(colEl,i){
  const det=document.getElementById('hDet');
  // Toggle off if clicking same hour
  if(det.classList.contains('v')&&det.dataset.idx===String(i)){det.classList.remove('v');colEl.classList.remove('sel');return}
  // Clear previous selection
  document.querySelectorAll('.hcol.sel').forEach(c=>c.classList.remove('sel'));
  colEl.classList.add('sel');
  const h=_hourlyData.hourly;
  const tmp=h.temperature_2m?.[i],dew=h.dew_point_2m?.[i],rh=h.relative_humidity_2m?.[i];
  const wnd=h.wind_speed_10m?.[i],gst=h.wind_gusts_10m?.[i],wdr=h.wind_direction_10m?.[i];
  const cld=h.cloud_cover?.[i],vis=h.visibility?.[i],prc=h.precipitation_probability?.[i],prs=h.surface_pressure?.[i];
  const spr=(tmp!=null&&dew!=null)?(tmp-dew).toFixed(1):null;
  const cBase=(tmp!=null&&dew!=null)?Math.round(((tmp-dew)/4.4)*1000):null;
  const cBStr=cBase!=null?(cBase>=1000?(cBase/1000).toFixed(1)+'k ft AGL':cBase+' ft AGL'):'‚Äî';
  const viMi=vis!=null?(vis/1609.34).toFixed(1):null;
  const inhg=prs!=null?(prs*0.02953).toFixed(2):null;
  const timeStr=new Date(h.time[i]).toLocaleString('en-US',{timeZone:getTZ(),weekday:'short',hour:'numeric',minute:'2-digit',hour12:true});
  det.dataset.idx=String(i);
  det.innerHTML=`<div class="hdet-hdr"><div class="hdet-time">${timeStr}</div><button class="hdet-close" onclick="document.getElementById('hDet').classList.remove('v');document.querySelectorAll('.hcol.sel').forEach(c=>c.classList.remove('sel'))">‚úï</button></div>
  <div class="hdet-grid">
    <div class="hdet-item"><div class="hdet-lbl">Temperature</div><div class="hdet-val">${tmp!=null?Math.round(tmp):'‚Äî'}¬∞F</div></div>
    <div class="hdet-item"><div class="hdet-lbl">Dew Point</div><div class="hdet-val">${dew!=null?Math.round(dew):'‚Äî'}¬∞F</div></div>
    <div class="hdet-item"><div class="hdet-lbl">Spread</div><div class="hdet-val" style="color:${spr!=null?spC(spr):'inherit'}">${spr??'‚Äî'}¬∞F</div><div class="hdet-sub">${spr!=null&&spr<=3?'‚ö† Fog risk':spr!=null&&spr<=5?'Watch':'OK'}</div></div>
    <div class="hdet-item"><div class="hdet-lbl">Wind</div><div class="hdet-val" style="color:${wnd!=null?wC(wnd):'var(--tx3)'}">${wnd!=null?Math.round(wnd):'‚Äî'} mph</div><div class="hdet-sub">${fDir(wdr)}</div></div>
    <div class="hdet-item"><div class="hdet-lbl">Gusts</div><div class="hdet-val" style="color:${gst!=null&&gst>=C.gThr?'var(--gust)':'inherit'}">${gst!=null?Math.round(gst):'‚Äî'} mph</div></div>
    <div class="hdet-item"><div class="hdet-lbl">Humidity</div><div class="hdet-val">${rh!=null?Math.round(rh):'‚Äî'}%</div></div>
    <div class="hdet-item"><div class="hdet-lbl">Cloud Cover</div><div class="hdet-val">${cld!=null?Math.round(cld):'‚Äî'}%</div></div>
    <div class="hdet-item"><div class="hdet-lbl">Est. Cloud Base</div><div class="hdet-val">${cBStr}</div></div>
    <div class="hdet-item"><div class="hdet-lbl">Precip Chance</div><div class="hdet-val" style="color:${prc>30?'var(--blue)':'inherit'}">${prc!=null?Math.round(prc):'‚Äî'}%</div></div>
    <div class="hdet-item"><div class="hdet-lbl">Visibility</div><div class="hdet-val">${viMi??'‚Äî'} mi</div></div>
    <div class="hdet-item"><div class="hdet-lbl">Pressure</div><div class="hdet-val">${inhg??'‚Äî'} inHg</div></div>
  </div>`;
  det.classList.add('v');
  det.scrollIntoView({behavior:'smooth',block:'nearest'});
}

// ‚ïê‚ïê‚ïê AFD ‚ïê‚ïê‚ïê
function rAFD(d){
  const el=document.getElementById('afdB'),tl=document.getElementById('afdT');
  tl.textContent=(C.nwsOffice||'NWS')+' ¬∑ '+new Date(d.time).toLocaleString('en-US',{timeZone:getTZ(),month:'short',day:'numeric',hour:'numeric',minute:'2-digit'});
  if(C.nwsOffice)tl.href=`https://forecast.weather.gov/product.php?site=${C.nwsOffice.toLowerCase()}&issuedby=${C.nwsOffice}&product=AFD`;
  const txt=d.text||'',lo=txt.toLowerCase(),found=new Map();
  for(const[kw,cfg]of Object.entries(C.kw)){if(lo.includes(kw))found.set(cfg.l,cfg)}
  const sents=txt.split(/[.!]\s+/).filter(s=>s.trim().length>20),kwS=new Set(Object.keys(C.kw));
  let hl=txt.replace(/</g,'&lt;').replace(/>/g,'&gt;');
  for(const[kw,cfg]of Object.entries(C.kw)){hl=hl.replace(new RegExp(`(${kw.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`,'gi'),`<span class="${cfg.h}">$1</span>`)}
  // Build color-coded bullets: match each sentence to its keyword category
  const colorPts=[];
  for(const s of sents){const sl=s.toLowerCase();for(const kw of kwS){if(sl.includes(kw)&&colorPts.length<6){const cl=s.trim().replace(/\n/g,' ').replace(/\s+/g,' ');if(cl.length>30&&cl.length<300){const cfg=C.kw[kw];colorPts.push({text:cl+'.',cat:cfg.c});break}}}}
  const ofc=(C.nwsOffice||'sgx').toLowerCase();
  let o='<div class="afd-split">';
  // Left: notes panel
  o+='<div class="afd-notes">';
  if(found.size>0){o+='<div class="asum"><div class="asmt">Detected Keywords</div><div class="akws">';for(const[l,cfg]of found)o+=`<span class="akw ${cfg.c}">${l}</span>`;o+='</div></div>'}
  if(colorPts.length){o+='<ul class="apts">';colorPts.forEach(p=>o+=`<li class="apt ${p.cat}">${p.text}</li>`);o+='</ul>'}
  o+=`<a class="aext" href="https://forecast.weather.gov/product.php?site=${ofc}&issuedby=${C.nwsOffice||'SGX'}&product=AFD" target="_blank" rel="noopener">Open on NWS ‚Üó</a>`;
  o+='</div>';
  // Right: full discussion
  o+=`<div class="afd-disc"><div class="afull" id="aFull">${hl}</div></div>`;
  o+='</div>';
  el.innerHTML=o;
}
function togAFD(){const e=document.getElementById('aFull'),b=e.previousElementSibling;e.classList.toggle('v');b.textContent=e.classList.contains('v')?'Hide Full Discussion':'Show Full Discussion'}

// ‚ïê‚ïê‚ïê AVIATION BRIEFING ‚ïê‚ïê‚ïê
function haverNm(lat1,lon1,lat2,lon2){const R=3440.065;const toR=d=>d*Math.PI/180;const dLat=toR(lat2-lat1),dLon=toR(lon2-lon1);const a=Math.sin(dLat/2)**2+Math.cos(toR(lat1))*Math.cos(toR(lat2))*Math.sin(dLon/2)**2;return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))}

function rAvBriefing(tafs,airSig,pireps){
  const el=document.getElementById('avB');
  let o='';

  // ‚îÄ‚îÄ TAFs ‚îÄ‚îÄ
  const tafKeys=Object.keys(tafs);
  if(tafKeys.length){
    o+='<div class="ab-sec"><div class="ab-st">üéØ Terminal Aerodrome Forecasts (TAF)</div>';
    tafKeys.forEach(id=>{
      const t=tafs[id];
      const iss=t.issueTime?fT(t.issueTime):'';
      const vf=t.validFrom?fT(t.validFrom):'';
      const vt=t.validTo?fT(t.validTo):'';
      o+=`<div class="ab-item"><div><span class="ab-stn">${id}</span>`;
      if(iss)o+=`<span class="ab-tm">Issued ${iss}</span>`;
      o+=`</div>`;
      if(vf||vt)o+=`<div style="margin-top:3px;font-size:9px;color:var(--tx4)">Valid ${vf}${vt?' ‚Äî '+vt:''}</div>`;
      if(t.raw)o+=`<div class="ab-raw">${t.raw.replace(/</g,'&lt;')}</div>`;
      o+='</div>';
    });
    o+='</div>';
  }else{
    o+='<div class="ab-sec"><div class="ab-st">üéØ Terminal Aerodrome Forecasts (TAF)</div><div class="ab-none">No TAFs available for nearby stations</div></div>';
  }

  // ‚îÄ‚îÄ SIGMETs & AIRMETs ‚îÄ‚îÄ
  // Filter by proximity ‚Äî items may have lat/lon or coords array
  const nearby=airSig.filter(item=>{
    const lat=item.lat||item.latitude||(item.coords?.[1]);
    const lon=item.lon||item.longitude||(item.coords?.[0]);
    if(lat!=null&&lon!=null)return haverNm(C.lat,C.lon,lat,lon)<=150;
    // If no coords, include if it mentions our state/region or is CONUS-wide
    return true;
  });
  const sigmets=nearby.filter(i=>(i.airsigmetType||i.type||'').toLowerCase().includes('sigmet'));
  const airmets=nearby.filter(i=>{const t=(i.airsigmetType||i.type||'').toLowerCase();return t.includes('airmet')||t.includes('g-airmet')});
  const other=nearby.filter(i=>{const t=(i.airsigmetType||i.type||'').toLowerCase();return!t.includes('sigmet')&&!t.includes('airmet')});

  if(sigmets.length){
    o+='<div class="ab-sec"><div class="ab-st">‚ö†Ô∏è SIGMETs</div>';
    sigmets.slice(0,5).forEach(s=>{
      const haz=s.hazard||s.hazardType||s.rawAirSigmet?.substring(0,40)||'Active';
      const sev=s.severity||'';
      const vf=s.validTimeFrom?fT(s.validTimeFrom):'';
      const vt=s.validTimeTo?fT(s.validTimeTo):'';
      const raw=s.rawAirSigmet||s.rawText||s.raw||'';
      o+=`<div class="ab-item"><span class="ab-haz sig">SIGMET${sev?' ¬∑ '+sev:''}</span>`;
      if(haz&&haz!=='Active')o+=`<span style="font-size:10px;color:var(--tx2);font-weight:600">${haz}</span>`;
      if(vf||vt)o+=`<div style="font-size:9px;color:var(--tx4);margin-top:3px">Valid ${vf}${vt?' ‚Äî '+vt:''}</div>`;
      if(raw)o+=`<div class="ab-raw">${raw.replace(/</g,'&lt;').substring(0,300)}</div>`;
      o+='</div>';
    });
    if(sigmets.length>5)o+=`<div style="font-size:10px;color:var(--tx3);padding:6px 0">+${sigmets.length-5} more SIGMETs</div>`;
    o+='</div>';
  }

  if(airmets.length){
    o+='<div class="ab-sec"><div class="ab-st">‚ö° AIRMETs / G-AIRMETs</div>';
    airmets.slice(0,5).forEach(a=>{
      const haz=a.hazard||a.hazardType||'Active';
      const vf=a.validTimeFrom?fT(a.validTimeFrom):'';
      const vt=a.validTimeTo?fT(a.validTimeTo):'';
      const raw=a.rawAirSigmet||a.rawText||a.raw||'';
      o+=`<div class="ab-item"><span class="ab-haz air">AIRMET</span>`;
      if(haz&&haz!=='Active')o+=`<span style="font-size:10px;color:var(--tx2);font-weight:600">${haz}</span>`;
      if(vf||vt)o+=`<div style="font-size:9px;color:var(--tx4);margin-top:3px">Valid ${vf}${vt?' ‚Äî '+vt:''}</div>`;
      if(raw)o+=`<div class="ab-raw">${raw.replace(/</g,'&lt;').substring(0,300)}</div>`;
      o+='</div>';
    });
    if(airmets.length>5)o+=`<div style="font-size:10px;color:var(--tx3);padding:6px 0">+${airmets.length-5} more AIRMETs</div>`;
    o+='</div>';
  }

  if(!sigmets.length&&!airmets.length){
    o+='<div class="ab-sec"><div class="ab-st">‚úÖ SIGMETs / AIRMETs</div><div class="ab-none">No active SIGMETs or AIRMETs in your area</div></div>';
  }

  // ‚îÄ‚îÄ PIREPs ‚îÄ‚îÄ
  if(pireps.length){
    o+='<div class="ab-sec"><div class="ab-st">‚úàÔ∏è Pilot Reports (PIREPs)</div>';
    pireps.slice(0,6).forEach(p=>{
      const tp=p.reportType||p.pirepType||(p.rawOb?.startsWith('UUA')?'UUA':'UA');
      const tm=p.obsTime||p.receiptTime||'';
      const tmS=tm?fT(tm):'';
      const alt=p.fltlvl||p.altitudeFt||p.altitude||'';
      const altS=alt?(typeof alt==='number'?'FL'+String(Math.round(alt/100)).padStart(3,'0'):alt):'';
      const raw=p.rawOb||p.rawText||p.raw||'';
      o+=`<div class="ab-item"><span class="ab-haz pir">${tp}</span>`;
      if(tmS)o+=`<span class="ab-tm">${tmS}</span>`;
      if(altS)o+=`<span class="ab-tm">${altS}</span>`;
      if(raw)o+=`<div style="margin-top:4px;font-size:10px;color:var(--tx2);font-family:'JetBrains Mono',monospace;word-break:break-all">${raw.replace(/</g,'&lt;').substring(0,200)}</div>`;
      o+='</div>';
    });
    if(pireps.length>6)o+=`<div style="font-size:10px;color:var(--tx3);padding:6px 0">+${pireps.length-6} more PIREPs nearby</div>`;
    o+='</div>';
  }

  // ‚îÄ‚îÄ TFRs (link only) ‚îÄ‚îÄ
  o+='<div class="ab-sec"><div class="ab-st">üöÅ Temporary Flight Restrictions (TFR)</div>';
  o+=`<div style="font-size:11px;color:var(--tx3);margin-bottom:8px">Check FAA for current TFRs in your area</div>`;
  o+=`<a class="ab-tfr" href="https://tfr.faa.gov/tfr3/" target="_blank" rel="noopener">View FAA TFR Map ‚Üó</a>`;
  o+='</div>';

  // ‚îÄ‚îÄ External links ‚îÄ‚îÄ
  o+=`<div class="ab-links"><a href="https://ppg.report/${C.lat},${C.lon}" target="_blank" rel="noopener">PPG Report ‚Üó</a><a href="https://aviationweather.gov/" target="_blank" rel="noopener">Aviation Weather ‚Üó</a><a href="https://tfr.faa.gov/tfr3/" target="_blank" rel="noopener">FAA TFRs ‚Üó</a><a href="https://www.1800wxbrief.com/" target="_blank" rel="noopener">1800WxBrief ‚Üó</a></div>`;

  el.innerHTML=o;
}

// ‚ïê‚ïê‚ïê REFRESH ‚ïê‚ïê‚ïê
let busy=false;
async function refreshAll(){if(busy)return;busy=true;document.getElementById('rbtn').classList.add('ld');
  try{
    // Fetch weather data for all stations + AFD + METARs in parallel
    const fetches=C.stations.map(s=>fetchOM(s.lat,s.lon).catch(e=>{console.warn('OM',s.label,e);return null}));
    const [stnData,afd,metars,tafs,airSig,pireps]=await Promise.all([
      Promise.all(fetches),
      fetchAFD().catch(e=>{console.warn('AFD:',e);return null}),
      fetchMETARs().catch(e=>{console.warn('METAR:',e);return{}}),
      fetchTAFs().catch(e=>{console.warn('TAF:',e);return{}}),
      fetchAirSigmet().catch(e=>{console.warn('AIRSIGMET:',e);return[]}),
      fetchPIREPs().catch(e=>{console.warn('PIREP:',e);return[]})
    ]);
    // Build keyed data object
    const allData={};C.stations.forEach((s,i)=>{allData[s.label]=stnData[i]});
    // Render
    const homeData=stnData[0]||stnData.find(d=>d!=null);
    _allStnData=allData;
    if(homeData){rSurf(homeData,metars);rHourly(homeData)}
    rMicroProfile(allData);
    rProfile(allData);
    if(afd)rAFD(afd);else document.getElementById('afdB').innerHTML='<div class="err">AFD unavailable</div>';
    rAvBriefing(tafs,airSig,pireps);
    document.getElementById('upd').textContent='Updated '+new Date().toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',second:'2-digit',hour12:true,timeZone:getTZ()});
  }catch(e){console.error(e);document.getElementById('surfB').innerHTML=`<div class="err">Error: ${e.message}</div>`}
  finally{busy=false;document.getElementById('rbtn').classList.remove('ld')}}

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
const CFG_VER=2; // bump this to force station rediscovery for all users
document.addEventListener('DOMContentLoaded',()=>{
  // Load saved location from localStorage
  try{
    const saved=localStorage.getItem('balloonWeatherLoc');
    if(saved){const s=JSON.parse(saved);
      if(s.lat&&s.lon){
        C.lat=s.lat;C.lon=s.lon;C.elev=s.elev||0;C.name=s.name||'Unknown';C.locName=s.locName||s.name||'Unknown';
        C.timezone=s.timezone||'America/New_York';C.nwsOffice=s.nwsOffice||'';
        C.metarStns=s.metarStns||C.metarStns;
        // Only load saved stations if config version matches ‚Äî otherwise use fresh defaults
        if(s.cfgVer===CFG_VER&&s.stations&&s.stations.length>=6){C.stations=s.stations}
        else{console.log('Station config outdated, using defaults + rediscovering...');
          // Trigger async rediscovery with new broader logic
          setTimeout(()=>selectLocation({name:C.name,lat:C.lat,lon:C.lon,elevation:C.elev/3.28084,timezone:C.timezone}),2000);
        }
      }
    }
  }catch(e){console.warn('Load location:',e)}
  updateUI();
  refreshAll();
  setInterval(refreshAll,5*60*1000);
});
</script>
</body>
</html>
