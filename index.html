<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Temecula Balloon Weather</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;700&family=JetBrains+Mono:wght@300;400;500;700&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0a0e1a;--card:#111827;--card2:#0f1525;--bdr:#1e293b;--bdr2:#2a3a52;
  --tx:#e8ecf4;--tx2:#8b97b0;--tx3:#5a6680;--tx4:#3d4a60;
  --calm:#34d399;--mod:#fbbf24;--strong:#fb923c;--danger:#f87171;
  --blue:#38bdf8;--cyan:#22d3ee;--violet:#a78bfa;
  --gust:#ff6b35;--gust-bg:rgba(255,107,53,.08);--gust-bdr:rgba(255,107,53,.25);
  --ks:#ef4444;--kp:#3b82f6;--km:#06b6d4;--kf:#a855f7;--kw:#f59e0b;--kt:#ec4899;
  --r:12px;--rs:8px;--sh:0 2px 12px rgba(0,0,0,.25);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:5px;height:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--bdr2);border-radius:3px}

.hdr{background:rgba(10,14,26,.88);backdrop-filter:blur(16px);border-bottom:1px solid var(--bdr);padding:12px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.hdr-l{display:flex;align-items:center;gap:12px}
.logo{width:36px;height:36px;background:linear-gradient(135deg,var(--mod),#f97316);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.hdr-title{font-family:'Instrument Serif',serif;font-size:21px}
.hdr-sub{font-size:11px;color:var(--tx3);margin-top:-2px}
.hdr-r{display:flex;align-items:center;gap:14px}
.upd{font-size:10px;color:var(--tx3);font-family:'JetBrains Mono',monospace}
.rbtn{background:var(--card);border:1px solid var(--bdr);color:var(--tx2);padding:6px 13px;border-radius:var(--rs);cursor:pointer;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:500;transition:all .15s;display:flex;align-items:center;gap:5px}
.rbtn:hover{background:var(--card2);border-color:var(--bdr2);color:var(--tx)}
.rbtn.ld .ri{animation:sp .8s linear infinite}@keyframes sp{to{transform:rotate(360deg)}}.ri{display:inline-block}

.ga{background:var(--gust-bg);border:1px solid var(--gust-bdr);border-radius:var(--rs);padding:10px 18px;margin:12px 24px 0;display:none;align-items:center;gap:10px;font-size:13px;font-weight:500;color:var(--gust);animation:pulse 3s ease-in-out infinite}
.ga.v{display:flex}@keyframes pulse{0%,100%{border-color:rgba(255,107,53,.25)}50%{border-color:rgba(255,107,53,.5)}}

.dash{max-width:1400px;margin:0 auto;padding:16px 24px 60px;display:grid;grid-template-columns:1fr 1fr;gap:14px}
.full{grid-column:1/-1}
@media(max-width:900px){.dash{grid-template-columns:1fr;padding:12px 14px 40px}.full{grid-column:1}}

.cd{background:var(--card);border:1px solid var(--bdr);border-radius:var(--r);box-shadow:var(--sh);overflow:clip;transition:border-color .2s}.cd:hover{border-color:var(--bdr2)}
.ch{padding:12px 18px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(30,41,59,.5)}
.ct{font-size:12px;font-weight:600;color:var(--tx2);text-transform:uppercase;letter-spacing:.06em;display:flex;align-items:center;gap:7px}
.ct .sub{font-weight:400;color:var(--tx3);text-transform:none;letter-spacing:0;font-size:11px;margin-left:4px}
.badge{font-size:10px;font-family:'JetBrains Mono',monospace;background:rgba(56,189,248,.1);color:var(--blue);padding:2px 8px;border-radius:12px}
.body{padding:16px 18px}
.ch.tg{cursor:pointer;user-select:none;transition:background .15s}.ch.tg:hover{background:rgba(255,255,255,.02)}
.ch.tg .chv{transition:transform .25s;font-size:12px;color:var(--tx3);margin-left:8px;flex-shrink:0}
.ch.tg.open .chv{transform:rotate(180deg)}.hide{display:none}

/* ‚ïê‚ïê‚ïê COMPASS ‚ïê‚ïê‚ïê */
.cw{display:flex;align-items:center;justify-content:center;gap:40px;flex-wrap:wrap;padding:8px 0}
.cbox{position:relative;width:210px;height:210px}
.cring{width:100%;height:100%;border-radius:50%;border:2px solid var(--bdr);position:relative;background:radial-gradient(circle,rgba(17,24,39,.6),rgba(15,21,37,.95))}
.ctick{position:absolute;width:1px;height:8px;background:var(--tx4);top:4px;left:50%;transform-origin:0.5px 101px}
.clbl{position:absolute;font-size:11px;font-weight:700;color:var(--tx3);font-family:'JetBrains Mono',monospace}
.clbl.n{top:10px;left:50%;transform:translateX(-50%)}.clbl.s{bottom:10px;left:50%;transform:translateX(-50%)}
.clbl.e{right:12px;top:50%;transform:translateY(-50%)}.clbl.w{left:12px;top:50%;transform:translateY(-50%)}
.cneedle{position:absolute;top:50%;left:50%;transform-origin:center center;transition:transform .6s cubic-bezier(.4,0,.2,1)}
.cdot{position:absolute;top:50%;left:50%;width:8px;height:8px;border-radius:50%;background:var(--tx);transform:translate(-50%,-50%);z-index:2;box-shadow:0 0 6px rgba(255,255,255,.3)}
.cspeed{text-align:center;margin-top:14px;font-family:'JetBrains Mono',monospace}
.cspeed .big{font-size:44px;font-weight:700;line-height:1}.cspeed .unit{font-size:14px;color:var(--tx2);margin-left:3px}
.cspeed .dir{font-size:14px;color:var(--tx2);margin-top:2px}

/* ‚ïê‚ïê‚ïê STATS ‚ïê‚ïê‚ïê */
.stats{display:flex;flex-direction:column;gap:10px;min-width:210px}
.stat{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--card2);border-radius:var(--rs)}
.stat-lbl{font-size:11px;color:var(--tx3);font-weight:500}
.stat-val{font-family:'JetBrains Mono',monospace;font-size:16px;font-weight:600}
.stat-sub{font-size:10px;color:var(--tx3);font-family:'JetBrains Mono',monospace}
.gauge{height:4px;border-radius:2px;background:var(--bdr);margin-top:4px;overflow:hidden}
.gauge-fill{height:100%;border-radius:2px;transition:width .4s ease}

/* ‚ïê‚ïê‚ïê WIND PROFILE ‚Äî VECTOR FIELD ‚ïê‚ïê‚ïê */
.vf-wrap{padding:10px 0}
.vf-row{display:flex;align-items:center;gap:0;margin-bottom:2px}
.vf-alt{width:80px;flex-shrink:0;text-align:right;padding-right:12px;font-size:10px;color:var(--tx3);font-family:'JetBrains Mono',monospace;white-space:nowrap}
.vf-alt .msl{font-size:8px;color:var(--tx4);display:block}
.vf-cell{flex:1;height:56px;position:relative;display:flex;align-items:center;justify-content:center;gap:6px;border-bottom:1px solid rgba(30,41,59,.3)}
.vf-arrow-wrap{position:relative;display:flex;align-items:center;justify-content:center}
.vf-hdr{position:sticky;top:61px;z-index:10;background:var(--card);margin:0 -18px 4px;padding:6px 18px 4px;border-bottom:1px solid var(--bdr)}
.vf-info{width:140px;flex-shrink:0;padding-left:12px;font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--tx2);white-space:nowrap;display:flex;align-items:center;gap:6px}
.vf-spd{font-weight:600;font-size:12px}

/* ‚ïê‚ïê‚ïê HOURLY ‚ïê‚ïê‚ïê */
.hstrip{display:flex;gap:2px;overflow-x:auto;padding-bottom:6px}
.hcol{flex:0 0 52px;display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 3px;border-radius:6px;transition:background .15s}
.hcol:hover{background:rgba(255,255,255,.03)}.hcol.gy{background:var(--gust-bg);border:1px solid var(--gust-bdr)}
.htime{font-size:8px;color:var(--tx3);font-family:'JetBrains Mono',monospace;font-weight:500}
.htemp{font-size:13px;font-weight:600;font-family:'JetBrains Mono',monospace}
.hspd{font-size:9px;font-family:'JetBrains Mono',monospace;font-weight:500}
.hgust{font-size:8px;color:var(--gust);font-weight:600;font-family:'JetBrains Mono',monospace}
.hdir{font-size:7px;color:var(--tx3);font-family:'JetBrains Mono',monospace}
.hprc{font-size:8px;color:var(--blue);font-family:'JetBrains Mono',monospace;font-weight:600}
.hcb{font-size:7px;color:var(--tx4);font-family:'JetBrains Mono',monospace}
.ceil-wrap{margin-top:14px;padding-top:12px;border-top:1px solid var(--bdr)}
.ceil-lbl{font-size:10px;text-transform:uppercase;letter-spacing:.06em;color:var(--tx3);font-weight:600;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.ceil-stn{display:flex;align-items:center;gap:8px;padding:4px 0;font-family:'JetBrains Mono',monospace;font-size:11px}
.ceil-id{color:var(--blue);width:36px;font-weight:600;font-size:10px;flex-shrink:0}
.ceil-nm{color:var(--tx4);font-size:9px;width:60px;flex-shrink:0}
.ceil-layers{display:flex;gap:6px;flex-wrap:wrap}
.ceil-layer{padding:2px 8px;border-radius:4px;font-size:10px;font-weight:500}
.ceil-layer.few{background:rgba(52,211,153,.08);color:var(--calm)}
.ceil-layer.sct{background:rgba(251,191,36,.08);color:var(--mod)}
.ceil-layer.bkn{background:rgba(251,146,60,.08);color:var(--strong)}
.ceil-layer.ovc{background:rgba(248,113,113,.08);color:var(--danger)}
.ceil-layer.clr{background:rgba(52,211,153,.06);color:var(--calm)}
.hcbar{width:22px;height:3px;border-radius:2px;background:var(--bdr);overflow:hidden;margin-top:1px}
.hcfill{height:100%;background:var(--tx3);border-radius:2px}

/* ‚ïê‚ïê‚ïê COMPARISON ‚ïê‚ïê‚ïê */
.comp-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.comp-alt{background:var(--card2);border-radius:var(--rs);padding:12px;text-align:center}
.comp-alt-lbl{font-size:10px;color:var(--tx3);font-family:'JetBrains Mono',monospace;font-weight:600;text-transform:uppercase;margin-bottom:8px}
.comp-src{display:flex;flex-direction:column;gap:4px}
.comp-row{display:flex;align-items:center;justify-content:center;gap:4px;padding:3px 6px;border-radius:4px;font-size:10px;font-family:'JetBrains Mono',monospace}
.comp-row .nm{color:var(--tx3);font-weight:500;width:28px;text-align:left}
.comp-row .vl{font-weight:600}.comp-row .cd2{color:var(--tx3);font-size:9px}
.comp-row.ar{background:rgba(52,211,153,.06);border:1px solid rgba(52,211,153,.15)}
@media(max-width:600px){.comp-grid{grid-template-columns:repeat(2,1fr)}}

/* ‚ïê‚ïê‚ïê AFD ‚ïê‚ïê‚ïê */
.asum{padding:12px 14px;background:var(--card2);border-radius:var(--rs);margin-bottom:10px}
.asmt{font-size:10px;text-transform:uppercase;letter-spacing:.06em;color:var(--tx3);font-weight:600;margin-bottom:6px}
.akws{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:8px}
.akw{font-size:10px;padding:2px 9px;border-radius:14px;font-weight:500;font-family:'JetBrains Mono',monospace}
.akw.ks{background:rgba(239,68,68,.12);color:var(--ks)}.akw.kp{background:rgba(59,130,246,.12);color:var(--kp)}
.akw.km{background:rgba(6,182,212,.12);color:var(--km)}.akw.kf{background:rgba(168,85,247,.12);color:var(--kf)}
.akw.kw{background:rgba(245,158,11,.12);color:var(--kw)}.akw.kt{background:rgba(236,72,153,.12);color:var(--kt)}
.apts{list-style:none;display:flex;flex-direction:column;gap:5px}
.apt{font-size:12px;color:var(--tx);line-height:1.5;padding-left:12px;position:relative}
.apt::before{content:'‚Ä∫';position:absolute;left:0;color:var(--blue);font-weight:700}
.atog{background:none;border:1px solid var(--bdr);color:var(--tx2);padding:6px 14px;border-radius:var(--rs);cursor:pointer;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:500;width:100%;margin-top:10px;transition:all .15s}
.atog:hover{background:var(--card2);color:var(--tx)}
.afull{display:none;margin-top:10px;padding:14px;background:var(--card2);border-radius:var(--rs);font-family:'JetBrains Mono',monospace;font-size:11px;line-height:1.65;color:var(--tx2);white-space:pre-wrap;word-wrap:break-word;max-height:450px;overflow-y:auto}
.afull.v{display:block}
.afull .hs0{color:var(--ks);font-weight:600;background:rgba(239,68,68,.1);padding:0 2px;border-radius:2px}
.afull .hp0{color:var(--kp);font-weight:600;background:rgba(59,130,246,.1);padding:0 2px;border-radius:2px}
.afull .hm0{color:var(--km);font-weight:600;background:rgba(6,182,212,.1);padding:0 2px;border-radius:2px}
.afull .hf0{color:var(--kf);font-weight:600;background:rgba(168,85,247,.1);padding:0 2px;border-radius:2px}
.afull .hw0{color:var(--kw);font-weight:600;background:rgba(245,158,11,.1);padding:0 2px;border-radius:2px}
.afull .ht0{color:var(--kt);font-weight:600;background:rgba(236,72,153,.1);padding:0 2px;border-radius:2px}
.aext{display:inline-block;margin-top:8px;font-size:10px;color:var(--blue);text-decoration:none;font-family:'JetBrains Mono',monospace}.aext:hover{text-decoration:underline}

.efr{width:100%;height:420px;border:none;border-radius:var(--rs);background:var(--card2)}
.ldg{display:flex;align-items:center;justify-content:center;padding:30px;gap:6px}
.dot{width:5px;height:5px;border-radius:50%;background:var(--blue);animation:dp 1.2s ease-in-out infinite}
.dot:nth-child(2){animation-delay:.15s}.dot:nth-child(3){animation-delay:.3s}
@keyframes dp{0%,80%,100%{opacity:.2;transform:scale(.8)}40%{opacity:1;transform:scale(1.1)}}
.err{padding:12px;font-size:11px;color:var(--danger);font-family:'JetBrains Mono',monospace;background:rgba(248,113,113,.06);border-radius:var(--rs)}

.dtable{width:100%;border-collapse:collapse;font-family:'JetBrains Mono',monospace;font-size:11px;margin-top:12px}
.dtable th{text-align:left;padding:6px 8px;font-size:9px;text-transform:uppercase;letter-spacing:.05em;color:var(--tx3);font-weight:600;border-bottom:1px solid var(--bdr)}
.dtable td{padding:5px 8px;border-bottom:1px solid rgba(30,41,59,.4);white-space:nowrap}.dtable tr:hover td{background:rgba(56,189,248,.02)}
</style>
</head>
<body>
<header class="hdr"><div class="hdr-l"><div class="logo">üéà</div><div><div class="hdr-title">Temecula Balloon Weather</div><div class="hdr-sub">French Valley F70 ¬∑ 33.57¬∞N 117.13¬∞W ¬∑ 1,349 ft</div></div></div><div class="hdr-r"><div class="upd" id="upd">‚Äî</div><button class="rbtn" id="rbtn" onclick="refreshAll()"><span class="ri">‚Üª</span> Refresh</button></div></header>
<div class="ga" id="ga"><span>‚ö†</span><span id="gaTxt"></span></div>
<div class="dash">
  <div class="cd full"><div class="ch"><div class="ct">üå° Surface Conditions</div><div class="badge">Open-Meteo GFS</div></div><div class="body" id="surfB"><div class="ldg"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div></div>
  <div class="cd full"><div class="ch"><div class="ct">üéØ Winds Aloft<span class="sub">F70 ¬∑ SAN ¬∑ ONT</span></div><div class="badge" id="wTime">Loading‚Ä¶</div></div><div class="body" id="profB"><div class="ldg"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div></div>
  <div class="cd full"><div class="ch tg open" onclick="tog(this)"><div class="ct">üìä Hourly Forecast<span class="sub">Next 24h</span></div><span class="chv">‚ñæ</span></div><div class="body" id="hB"><div class="ldg"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div></div>
  <div class="cd full"><div class="ch tg" onclick="tog(this)"><div class="ct">‚öñ Source Comparison<span class="sub">SAN ¬∑ ONT ¬∑ F70 ¬∑ Blended</span></div><span class="chv">‚ñæ</span></div><div class="body hide" id="cB"><div class="ldg"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div></div>
  <div class="cd full"><div class="ch tg" onclick="tog(this)"><div class="ct">üìù Area Forecast Discussion</div><div class="badge" id="afdT">NWS SGX</div><span class="chv" style="margin-left:auto;padding-left:10px">‚ñæ</span></div><div class="body hide" id="afdB"><div class="ldg"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div></div>
  <div class="cd"><div class="ch tg" onclick="tog(this)"><div class="ct">üó∫ Wind Map</div><span class="chv">‚ñæ</span></div><div class="body hide" style="padding:0"><iframe class="efr" data-src="https://embed.windy.com/embed.html?type=map&location=coordinates&metricRain=default&metricTemp=%C2%B0F&metricWind=mph&zoom=9&overlay=wind&product=ecmwf&level=surface&lat=33.55&lon=-117.13" loading="lazy"></iframe></div></div>
  <div class="cd"><div class="ch tg" onclick="tog(this)"><div class="ct">ü™Ç PPG Report</div><span class="chv">‚ñæ</span></div><div class="body hide" style="padding:0"><div style="padding:14px 18px;text-align:center;border-bottom:1px solid var(--bdr)"><div style="font-size:11px;color:var(--tx3);margin-bottom:8px">Winds aloft ¬∑ TAFs ¬∑ TFRs ¬∑ SIGMETs ¬∑ G-AIRMETs</div><a href="https://ppg.report/33.495,-117.147" target="_blank" rel="noopener" style="display:inline-block;background:rgba(56,189,248,.1);color:var(--blue);border:1px solid rgba(56,189,248,.2);padding:7px 18px;border-radius:var(--rs);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;text-decoration:none">Open in Browser ‚Üó</a></div><div id="ppgMsg" style="display:none;padding:24px 18px;text-align:center;font-size:11px;color:var(--tx3)">Embed blocked by browser ‚Äî use the link above</div><iframe id="ppgFrame" class="efr" data-src="https://ppg.report/33.495,-117.147" referrerpolicy="no-referrer" style="height:460px"></iframe></div></div>
</div>
<script>
const C={elev:1349,stations:{SAN:{lat:32.73,lon:-117.19},ONT:{lat:34.06,lon:-117.60},F70:{lat:33.57,lon:-117.13}},
  levels:[{hPa:1000,msl:360},{hPa:975,msl:1050},{hPa:950,msl:1640},{hPa:925,msl:2625},{hPa:900,msl:3280},{hPa:875,msl:3940},{hPa:850,msl:4920},{hPa:825,msl:5580},{hPa:800,msl:6230},{hPa:775,msl:7220},{hPa:750,msl:8200},{hPa:700,msl:9840}],
  dispAlts:[1000,2000,3000,4000,5000,6000,7000,8000],gThr:10,metarStns:[{id:'KCRQ',nm:'Carlsbad',elev:331},{id:'KSAN',nm:'San Diego',elev:17},{id:'KONT',nm:'Ontario',elev:944},{id:'KSNA',nm:'Santa Ana',elev:56}],
  kw:{'santa ana':{c:'ks',h:'hs0',l:'Santa Ana'},'offshore flow':{c:'ks',h:'hs0',l:'Offshore Flow'},'sundowner':{c:'ks',h:'hs0',l:'Sundowner'},'low pressure':{c:'kp',h:'hp0',l:'Low Pressure'},'trough':{c:'kp',h:'hp0',l:'Trough'},'cold front':{c:'kp',h:'hp0',l:'Cold Front'},'warm front':{c:'kp',h:'hp0',l:'Warm Front'},'marine layer':{c:'km',h:'hm0',l:'Marine Layer'},'onshore flow':{c:'km',h:'hm0',l:'Onshore Flow'},'catalina eddy':{c:'km',h:'hm0',l:'Catalina Eddy'},'fog':{c:'kf',h:'hf0',l:'Fog'},'low stratus':{c:'kf',h:'hf0',l:'Low Stratus'},'visibility':{c:'kf',h:'hf0',l:'Visibility'},'wind shear':{c:'kw',h:'hw0',l:'Wind Shear'},'gusty':{c:'kw',h:'hw0',l:'Gusty'},'gusts':{c:'kw',h:'hw0',l:'Gusts'},'breezy':{c:'kw',h:'hw0',l:'Breezy'},'wind advisory':{c:'kw',h:'hw0',l:'Wind Advisory'},'high wind':{c:'kw',h:'hw0',l:'High Wind'},'turbulence':{c:'kt',h:'ht0',l:'Turbulence'},'convection':{c:'kt',h:'ht0',l:'Convection'},'thunderstorm':{c:'kt',h:'ht0',l:'Thunderstorm'}}
};
const cp=d=>{if(d==null||isNaN(d))return'‚Äî';return['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'][Math.round(d/22.5)%16]};
const wC=s=>s<5?'var(--calm)':s<10?'var(--mod)':s<15?'var(--strong)':'var(--danger)';
const wH=s=>s<5?'#34d399':s<10?'#fbbf24':s<15?'#fb923c':'#f87171';
const spC=s=>s<=3?'var(--danger)':s<=5?'var(--mod)':'var(--calm)';
const fT=iso=>new Date(iso).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true,timeZone:'America/Los_Angeles'});
const fH=iso=>new Date(iso).toLocaleTimeString('en-US',{hour:'numeric',hour12:true,timeZone:'America/Los_Angeles'});
const nI=t=>{const n=Date.now();let c=0,m=Infinity;t.forEach((v,i)=>{const d=Math.abs(new Date(v).getTime()-n);if(d<m){m=d;c=i}});return c};
const agl=msl=>msl-C.elev;
const pad3=d=>String(Math.round(((d%360)+360)%360)).padStart(3,'0');
const toD=d=>((Math.round(d)+180)%360);
const fDir=d=>d==null||isNaN(d)?'‚Äî':`To ${pad3(toD(d))} / From ${pad3(d)}`;
const fDirTF=d=>d==null||isNaN(d)?'‚Äî':`<div style="color:var(--tx2)">To ${cp(toD(d))} ${pad3(toD(d))}¬∞</div><div style="color:var(--tx4)">From ${cp(d)} ${pad3(d)}¬∞</div>`;

// Vector arrow SVG ‚Äî an elongated arrow that points in wind direction, length = speed
function vecArrow(dir, spd, maxSpd, color, cellW) {
  if(dir==null||spd==null) return '';
  const len = Math.max(8, (spd / maxSpd) * (cellW * 0.42));
  const r = (dir||0); // wind direction = where FROM, arrow points where it's going: +180
  const goDir = (r + 180) % 360;
  // SVG arrow centered, rotated to goDir
  return `<svg width="${cellW}" height="40" viewBox="0 0 ${cellW} 40" style="overflow:visible">
    <g transform="translate(${cellW/2},20) rotate(${goDir})">
      <line x1="0" y1="${len/2}" x2="0" y2="${-len/2}" stroke="${color}" stroke-width="2.5" stroke-linecap="round"/>
      <polygon points="0,${-len/2-4} -4,${-len/2+4} 4,${-len/2+4}" fill="${color}"/>
    </g>
  </svg>`;
}

// Small directional arrow for hourly/comparison
function smArrow(dir, col, sz) {
  if(dir==null) return '';
  const go = ((dir||0)+180)%360;
  return `<svg width="${sz}" height="${sz}" viewBox="0 0 24 24" style="display:block;margin:0 auto"><g transform="rotate(${go},12,12)"><line x1="12" y1="18" x2="12" y2="6" stroke="${col}" stroke-width="2.5" stroke-linecap="round"/><polygon points="12,4 8,10 16,10" fill="${col}"/></g></svg>`;
}

function tog(h){h.classList.toggle('open');const b=h.nextElementSibling;b.classList.toggle('hide');const f=b.querySelector('iframe[data-src]');if(f&&!f.src){void b.offsetHeight;f.src=f.dataset.src;f.removeAttribute('data-src');if(f.id==='ppgFrame')chkPPG(f)}}
function chkPPG(f){const ck=()=>{try{const l=f.contentWindow.location.href;if(!l||l==='about:blank'){f.style.display='none';const m=document.getElementById('ppgMsg');if(m)m.style.display='block'}}catch(e){}};f.addEventListener('load',()=>setTimeout(ck,500),{once:true});setTimeout(ck,5000)}

function omUrl(lat,lon){
  const pv=[];C.levels.forEach(l=>{pv.push(`wind_speed_${l.hPa}hPa`,`wind_direction_${l.hPa}hPa`,`temperature_${l.hPa}hPa`,`geopotential_height_${l.hPa}hPa`)});
  const sv=['temperature_2m','dew_point_2m','relative_humidity_2m','wind_speed_10m','wind_direction_10m','wind_gusts_10m','cloud_cover','visibility','precipitation_probability','surface_pressure'];
  return`https://api.open-meteo.com/v1/gfs?latitude=${lat}&longitude=${lon}&hourly=${[...sv,...pv].join(',')}&wind_speed_unit=mph&temperature_unit=fahrenheit&forecast_days=2&timezone=America/Los_Angeles&models=gfs_seamless`;
}
async function fetchOM(a,b){const r=await fetch(omUrl(a,b));if(!r.ok)throw new Error('Open-Meteo '+r.status);return r.json()}
async function fetchAFD(){
  const lr=await fetch('https://api.weather.gov/products/types/AFD/locations/SGX');if(!lr.ok)throw new Error('AFD '+lr.status);
  const ld=await lr.json();const id=ld['@graph']?.[0]?.id;if(!id)throw new Error('No AFD');
  const pr=await fetch(`https://api.weather.gov/products/${id}`);if(!pr.ok)throw new Error('AFD '+pr.status);
  const pd=await pr.json();return{text:pd.productText,time:pd.issuanceTime};
}

async function fetchMETARs(){const results={};await Promise.all(C.metarStns.map(async stn=>{try{const r=await fetch(`https://api.weather.gov/stations/${stn.id}/observations/latest`,{headers:{'Accept':'application/geo+json','User-Agent':'TemeculaBalloonWeather/1.0'}});if(!r.ok)return;const d=await r.json();results[stn.id]={name:stn.nm,elev:stn.elev,layers:d.properties?.cloudLayers||[],raw:d.properties?.rawMessage||'',time:d.properties?.timestamp}}catch(e){console.warn('METAR',stn.id,e)}}));return results}

// ‚ïê‚ïê‚ïê SURFACE ‚ïê‚ïê‚ïê
function rSurf(d,metars){
  const el=document.getElementById('surfB'),h=d.hourly,i=nI(h.time);
  const tmp=h.temperature_2m?.[i],dew=h.dew_point_2m?.[i],spr=(tmp!=null&&dew!=null)?(tmp-dew).toFixed(1):null;
  const wnd=h.wind_speed_10m?.[i],gst=h.wind_gusts_10m?.[i],wdr=h.wind_direction_10m?.[i];
  const cld=h.cloud_cover?.[i],vis=h.visibility?.[i],viMi=vis!=null?(vis/1609.34).toFixed(1):null;
  const prc=h.precipitation_probability?.[i],prs=h.surface_pressure?.[i],inhg=prs!=null?(prs*0.02953).toFixed(2):null;
  chkG(h,i);
  const wndCol=wnd!=null?wH(wnd):'#5a6680';
  // Compass ticks
  let ticks='';for(let a=0;a<360;a+=30){ticks+=`<div class="ctick" style="transform:rotate(${a}deg) translateX(-0.5px)"></div>`}

  let o=`<div class="cw"><div style="text-align:center">
    <div class="cbox"><div class="cring">${ticks}
      <span class="clbl n">N</span><span class="clbl s">S</span><span class="clbl e">E</span><span class="clbl w">W</span>
      <svg class="cneedle" width="210" height="210" viewBox="0 0 210 210" style="position:absolute;top:0;left:0;transform:rotate(${wdr!=null?(wdr+180)%360:0}deg)">
        <defs><linearGradient id="ng" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${wndCol}"/><stop offset="100%" stop-color="transparent"/></linearGradient></defs>
        <line x1="105" y1="105" x2="105" y2="${105 - Math.min(30 + (wnd||0)*3, 88)}" stroke="url(#ng)" stroke-width="3" stroke-linecap="round"/>
        <polygon points="105,${105 - Math.min(30 + (wnd||0)*3, 88) - 4} 101,${105 - Math.min(30 + (wnd||0)*3, 88) + 5} 109,${105 - Math.min(30 + (wnd||0)*3, 88) + 5}" fill="${wndCol}"/>
      </svg>
      <div class="cdot"></div>
    </div></div>
    <div class="cspeed"><div class="big" style="color:${wnd!=null?wC(wnd):'var(--tx)'}">${wnd!=null?Math.round(wnd):'‚Äî'}<span class="unit">mph</span></div>
    <div class="dir">${wdr!=null?fDir(wdr):'‚Äî'}</div>
    ${gst!=null&&gst>=C.gThr?`<div style="color:var(--gust);font-size:13px;margin-top:4px;font-weight:600">Gusts ${Math.round(gst)} mph</div>`:gst!=null?`<div style="color:var(--tx3);font-size:12px;margin-top:4px">Gusts ${Math.round(gst)} mph</div>`:''}</div>
  </div>`;
  // Stats
  const sprPct=spr!=null?Math.min((spr/15)*100,100):0;
  const cBase=(tmp!=null&&dew!=null)?Math.round(((tmp-dew)/4.4)*1000):null;const cBStr=cBase!=null?(cBase>=1000?(cBase/1000).toFixed(1)+'k ft AGL':cBase+' ft AGL'):'‚Äî';
  o+=`<div class="stats">
    <div class="stat"><div><div class="stat-lbl">Temperature</div><div class="stat-sub">Dew ${dew!=null?Math.round(dew):'‚Äî'}¬∞F</div></div><div class="stat-val">${tmp!=null?Math.round(tmp):'‚Äî'}¬∞F</div></div>
    <div class="stat"><div style="flex:1"><div style="display:flex;justify-content:space-between"><div class="stat-lbl">Temp/Dew Spread ${spr!=null&&spr<=3?'<span style="color:var(--danger)">‚ö† Fog</span>':spr!=null&&spr<=5?'<span style="color:var(--mod)">Watch</span>':''}</div><div class="stat-val" style="color:${spr!=null?spC(spr):'inherit'}">${spr??'‚Äî'}¬∞F</div></div><div class="gauge"><div class="gauge-fill" style="width:${sprPct}%;background:${spr!=null?spC(spr):'var(--tx3)'}"></div></div></div></div>
    <div class="stat"><div class="stat-lbl">Est. Cloud Base <span style="font-size:9px;color:var(--tx4)">(LCL)</span></div><div class="stat-val">${cBStr}</div></div>
    <div class="stat"><div style="flex:1"><div style="display:flex;justify-content:space-between"><div class="stat-lbl">Cloud Cover</div><div class="stat-val">${cld!=null?Math.round(cld):'‚Äî'}%</div></div><div class="gauge"><div class="gauge-fill" style="width:${cld??0}%;background:var(--tx3)"></div></div></div></div>
    <div class="stat"><div class="stat-lbl">Visibility</div><div class="stat-val">${viMi??'‚Äî'} mi</div></div>
    <div class="stat"><div class="stat-lbl">Precip Chance</div><div class="stat-val">${prc!=null?Math.round(prc):'‚Äî'}%</div></div>
    <div class="stat"><div class="stat-lbl">Pressure</div><div class="stat-val">${inhg??'‚Äî'} inHg</div></div>
  </div></div>`;
  // Reported Ceilings from METAR
  if(metars&&Object.keys(metars).length){
    const ceilCls={CLR:'clr',SKC:'clr',FEW:'few',SCT:'sct',BKN:'bkn',OVC:'ovc'};
    let loCeil=null,loStn=null;
    o+=`<div class="ceil-wrap"><div class="ceil-lbl">‚òÅ Reported Cloud Layers <span style="font-weight:400;color:var(--tx4);letter-spacing:0;text-transform:none;font-size:9px">METAR</span></div>`;
    for(const[id,m]of Object.entries(metars)){
      o+=`<div class="ceil-stn"><span class="ceil-id">${id}</span><span class="ceil-nm">${m.name}</span><div class="ceil-layers">`;
      const valid=m.layers.filter(l=>l.amount&&l.amount!=='CLR'&&l.amount!=='SKC');
      if(!valid.length){o+=`<span class="ceil-layer clr">CLR</span>`}
      else{valid.forEach(l=>{
        const bM=l.base?.value;const bFt=bM!=null?Math.round(bM*3.28084):null;
        const bS=bFt!=null?(bFt>=1000?(bFt/1000).toFixed(1)+'k':bFt+"'"):'';
        const cls=ceilCls[l.amount]||'';
        o+=`<span class="ceil-layer ${cls}">${l.amount} ${bS}</span>`;
        if((l.amount==='BKN'||l.amount==='OVC')&&bFt!=null){if(!loCeil||bFt<loCeil){loCeil=bFt;loStn=id}}
      })}
      o+=`</div></div>`;
    }
    if(loCeil!=null){
      const cs=loCeil>=1000?(loCeil/1000).toFixed(1)+'k':loCeil;
      o+=`<div style="margin-top:8px;padding:6px 10px;background:var(--card2);border-radius:var(--rs);font-size:11px;font-family:'JetBrains Mono',monospace;display:flex;align-items:center;gap:8px"><span style="color:var(--tx3)">Lowest ceiling:</span><span style="color:${loCeil<2000?'var(--danger)':loCeil<5000?'var(--mod)':'var(--calm)'};font-weight:700">${cs} ft AGL</span><span style="color:var(--tx4)">@ ${loStn}</span></div>`;
    }
    o+=`</div>`;
  }
  el.innerHTML=o;
}
function chkG(h,ci){const el=document.getElementById('ga'),tx=document.getElementById('gaTxt'),a=[];for(let i=ci;i<Math.min(ci+12,h.wind_gusts_10m.length);i++){const g=h.wind_gusts_10m[i];if(g!=null&&g>=C.gThr)a.push({t:h.time[i],g:Math.round(g)})}if(a.length){el.classList.add('v');tx.textContent=`Gusts up to ${Math.max(...a.map(x=>x.g))} mph ‚Äî first at ${fT(a[0].t)}, ${a.length} hr(s) in next 12h`}else el.classList.remove('v')}

// Interpolate wind data at a target MSL altitude between pressure levels
function interpAt(h,ti,tMSL){const pts=[];C.levels.forEach(l=>{const s=h[`wind_speed_${l.hPa}hPa`]?.[ti],d=h[`wind_direction_${l.hPa}hPa`]?.[ti],t=h[`temperature_${l.hPa}hPa`]?.[ti];if(s!=null&&d!=null)pts.push({msl:l.msl,spd:s,dir:d,tmp:t})});pts.sort((a,b)=>a.msl-b.msl);let lo=null,hi=null;for(let i=0;i<pts.length-1;i++){if(pts[i].msl<=tMSL&&pts[i+1].msl>=tMSL){lo=pts[i];hi=pts[i+1];break}}if(!lo||!hi)return null;const f=(tMSL-lo.msl)/(hi.msl-lo.msl);const spd=lo.spd+f*(hi.spd-lo.spd);const lr=lo.dir*Math.PI/180,hr=hi.dir*Math.PI/180;const u=Math.sin(lr)*(1-f)+Math.sin(hr)*f,v=Math.cos(lr)*(1-f)+Math.cos(hr)*f;const dir=((Math.atan2(u,v)*180/Math.PI)+360)%360;const tmp=(lo.tmp!=null&&hi.tmp!=null)?lo.tmp+f*(hi.tmp-lo.tmp):null;return{spd,dir,tmp}}

// ‚ïê‚ïê‚ïê WIND PROFILE ‚Äî VECTOR FIELD (MULTI-SOURCE) ‚ïê‚ïê‚ïê
function rProfile(allData){
  const el=document.getElementById('profB'),tl=document.getElementById('wTime');
  const sources=[
    {key:'F70',label:'F70',sub:'French Valley',data:allData.F70},
    {key:'SAN',label:'SAN',sub:'San Diego',data:allData.SAN},
    {key:'ONT',label:'ONT',sub:'Ontario',data:allData.ONT}
  ];
  const f70h=allData.F70.hourly,ci=nI(f70h.time);
  tl.textContent=fT(f70h.time[ci]);
  // Global max speed across all sources for consistent arrow scaling
  let maxSpd=15;
  const allLvl=C.levels.filter(l=>agl(l.msl)>=0);
  sources.forEach(src=>{const h=src.data.hourly,si=nI(h.time);allLvl.forEach(l=>{const s=h[`wind_speed_${l.hPa}hPa`]?.[si]||0;if(s>maxSpd)maxSpd=s})});
  const cellW=120;
  let o='<div class="vf-wrap">';
  // Source headers
  o+='<div class="vf-row vf-hdr">';
  o+='<div class="vf-alt"></div>';
  sources.forEach((src,i)=>{o+=`<div class="vf-cell" style="height:auto;border:none;padding:6px 0${i>0?';border-left:1px solid rgba(30,41,59,.3)':''}"><div style="font-size:12px;font-weight:700;color:var(--tx);font-family:'JetBrains Mono',monospace">${src.label}</div><div style="font-size:9px;color:var(--tx4);margin-top:1px">${src.sub}</div></div>`});
  o+='</div>';
  // Altitude rows at even 1000-ft AGL intervals (interpolated from pressure levels)
  C.dispAlts.slice().reverse().forEach(ag=>{
    const msl=ag+C.elev,al=(ag/1000)+'k',ml=(msl/1000).toFixed(1)+'k';
    o+='<div class="vf-row">';
    o+=`<div class="vf-alt">${al} ft<span class="msl">${ml} MSL</span></div>`;
    sources.forEach((src,i)=>{
      const h=src.data.hourly,si=nI(h.time);
      const w=interpAt(h,si,msl);const spd=w?.spd??null,dir=w?.dir??null;
      const col=spd!=null?wH(spd):'#3d4a60';
      o+=`<div class="vf-cell"${i>0?' style="border-left:1px solid rgba(30,41,59,.3)"':''}>${vecArrow(dir,spd,maxSpd,col,cellW)}<div style="font-family:'JetBrains Mono',monospace;white-space:nowrap;text-align:left"><div style="color:${spd!=null?wC(spd):'var(--tx3)'};font-weight:700;font-size:14px">${spd!=null?Math.round(spd):'‚Äî'} <span style="font-size:11px;font-weight:400">mph</span></div><div style="font-size:10px;line-height:1.4">${fDirTF(dir)}</div></div></div>`;
    });
    o+='</div>';
  });
  o+='</div>';
  // F70 Data table
  o+=`<div style="text-align:center;margin-top:8px"><button class="atog" onclick="this.nextElementSibling.classList.toggle('hide');this.textContent=this.nextElementSibling.classList.contains('hide')?'Show F70 6-Hour Data Table':'Hide Data Table'" style="width:auto;display:inline-block;padding:5px 16px">Show F70 6-Hour Data Table</button>`;
  const hrs=[];for(let i=ci;i<Math.min(ci+6,f70h.time.length);i++)hrs.push(i);
  o+=`<div class="hide"><table class="dtable"><thead><tr><th>Alt</th>`;hrs.forEach((hi,j)=>o+=`<th>${j===0?'Now':fH(f70h.time[hi])}</th>`);o+=`</tr></thead><tbody>`;
  C.dispAlts.forEach(ag=>{const msl=ag+C.elev,al=(ag/1000)+'k ft';
    o+=`<tr><td style="color:var(--tx2)">${al}</td>`;
    hrs.forEach(hi=>{const w=interpAt(f70h,hi,msl);const spd=w?.spd??null,dir=w?.dir??null,tmp=w?.tmp??null,col=spd!=null?wC(spd):'var(--tx3)';
      o+=`<td><span style="color:${col};font-weight:600">${spd!=null?Math.round(spd):'‚Äî'}</span> <span style="color:var(--tx3);font-size:9px">${fDir(dir)}</span>${tmp!=null?` <span style="font-size:9px;color:var(--tx4)">${Math.round(tmp)}¬∞F</span>`:''}</td>`;
    });o+='</tr>';});
  o+=`</tbody></table></div></div>`;
  el.innerHTML=o;
}

// ‚ïê‚ïê‚ïê HOURLY ‚ïê‚ïê‚ïê
function rHourly(d){
  const el=document.getElementById('hB'),h=d.hourly,ci=nI(h.time);let o='<div class="hstrip">';
  for(let i=ci;i<Math.min(ci+24,h.time.length);i++){
    const tmp=h.temperature_2m?.[i],dew=h.dew_point_2m?.[i],wnd=h.wind_speed_10m?.[i],gst=h.wind_gusts_10m?.[i],wdr=h.wind_direction_10m?.[i],cld=h.cloud_cover?.[i],prc=h.precipitation_probability?.[i],gy=gst!=null&&gst>=C.gThr;
    const col=wnd!=null?wH(wnd):'#3d4a60';
    const cBase=(tmp!=null&&dew!=null)?Math.round(((tmp-dew)/4.4)*1000):null;const cBFmt=cBase!=null?(cBase>=1000?(cBase/1000).toFixed(1)+'k':cBase+'\''):'‚Äî';
    o+=`<div class="hcol${gy?' gy':''}"><div class="htime">${i===ci?'Now':fH(h.time[i])}</div><div class="htemp">${tmp!=null?Math.round(tmp):'‚Äî'}¬∞</div>
      ${prc!=null&&prc>0?`<div class="hprc">${Math.round(prc)}%</div>`:''}
      ${smArrow(wdr,col,22)}
      <div class="hspd" style="color:${wnd!=null?wC(wnd):'var(--tx3)'}">${wnd!=null?Math.round(wnd):'‚Äî'}</div>
      ${gy?`<div class="hgust">G${Math.round(gst)}</div>`:''}<div class="hdir">${wdr!=null?'‚Üí'+pad3(toD(wdr))+' ‚Üê'+pad3(wdr):'‚Äî'}</div>
      <div class="hcb">‚òÅ${cBFmt}</div>
      <div class="hcbar"><div class="hcfill" style="width:${cld??0}%"></div></div></div>`;
  }
  o+='</div>';el.innerHTML=o;
}

// ‚ïê‚ïê‚ïê COMPARISON ‚ïê‚ïê‚ïê
function rComp(data){
  const el=document.getElementById('cB'),alts=[{hPa:925,lbl:'3,000 ft'},{hPa:850,lbl:'5,000 ft'},{hPa:800,lbl:'6,000 ft'},{hPa:700,lbl:'10,000 ft'}];
  let o='<div class="comp-grid">';
  alts.forEach(a=>{
    o+=`<div class="comp-alt"><div class="comp-alt-lbl">${a.lbl}</div><div class="comp-src">`;
    const vals=[];
    for(const[k,d]of Object.entries(data)){
      const ci=nI(d.hourly.time),spd=d.hourly[`wind_speed_${a.hPa}hPa`]?.[ci],dir=d.hourly[`wind_direction_${a.hPa}hPa`]?.[ci];
      vals.push({spd,dir});const col=spd!=null?wH(spd):'#3d4a60';
      o+=`<div class="comp-row"><span class="nm">${k}</span>${smArrow(dir,col,14)}<span class="vl" style="color:${spd!=null?wC(spd):'var(--tx3)'}">${spd!=null?Math.round(spd):'‚Äî'}</span><span class="cd2">${fDir(dir)}</span></div>`;
    }
    const vf=vals.filter(v=>v.spd!=null);
    if(vf.length){const as=vf.reduce((a,v)=>a+v.spd,0)/vf.length;const sn=vf.reduce((a,v)=>a+Math.sin(v.dir*Math.PI/180),0)/vf.length,cs=vf.reduce((a,v)=>a+Math.cos(v.dir*Math.PI/180),0)/vf.length;const ad=((Math.atan2(sn,cs)*180/Math.PI)+360)%360;
      o+=`<div class="comp-row ar"><span class="nm" style="color:var(--calm)">AVG</span>${smArrow(ad,wH(as),14)}<span class="vl" style="color:${wC(as)}">${Math.round(as)}</span><span class="cd2">${fDir(ad)}</span></div>`}
    o+=`</div></div>`;});
  o+='</div>';el.innerHTML=o;
}

// ‚ïê‚ïê‚ïê AFD ‚ïê‚ïê‚ïê
function rAFD(d){
  const el=document.getElementById('afdB'),tl=document.getElementById('afdT');
  tl.textContent='SGX ¬∑ '+new Date(d.time).toLocaleString('en-US',{timeZone:'America/Los_Angeles',month:'short',day:'numeric',hour:'numeric',minute:'2-digit'});
  const txt=d.text||'',lo=txt.toLowerCase(),found=new Map();
  for(const[kw,cfg]of Object.entries(C.kw)){if(lo.includes(kw))found.set(cfg.l,cfg)}
  const sents=txt.split(/[.!]\s+/).filter(s=>s.trim().length>20),pts=[],kwS=new Set(Object.keys(C.kw));
  for(const s of sents){const sl=s.toLowerCase();for(const kw of kwS){if(sl.includes(kw)&&pts.length<6){const cl=s.trim().replace(/\n/g,' ').replace(/\s+/g,' ');if(cl.length>30&&cl.length<300){pts.push(cl+'.');break}}}}
  let hl=txt.replace(/</g,'&lt;').replace(/>/g,'&gt;');
  for(const[kw,cfg]of Object.entries(C.kw)){hl=hl.replace(new RegExp(`(${kw.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`,'gi'),`<span class="${cfg.h}">$1</span>`)}
  let o='';if(found.size>0){o+='<div class="asum"><div class="asmt">Detected Keywords</div><div class="akws">';for(const[l,cfg]of found)o+=`<span class="akw ${cfg.c}">${l}</span>`;o+='</div>';if(pts.length){o+='<ul class="apts">';pts.forEach(p=>o+=`<li class="apt">${p}</li>`);o+='</ul>'}o+='</div>'}
  o+=`<button class="atog" onclick="togAFD()">Show Full Discussion</button><div class="afull" id="aFull">${hl}</div><a class="aext" href="https://forecast.weather.gov/product.php?site=sgx&issuedby=SGX&product=AFD" target="_blank" rel="noopener">Open on NWS website ‚Üó</a>`;el.innerHTML=o;
}
function togAFD(){const e=document.getElementById('aFull'),b=e.previousElementSibling;e.classList.toggle('v');b.textContent=e.classList.contains('v')?'Hide Full Discussion':'Show Full Discussion'}

let busy=false;
async function refreshAll(){if(busy)return;busy=true;document.getElementById('rbtn').classList.add('ld');
  try{const[f70,san,ont,afd,metars]=await Promise.all([fetchOM(C.stations.F70.lat,C.stations.F70.lon),fetchOM(C.stations.SAN.lat,C.stations.SAN.lon),fetchOM(C.stations.ONT.lat,C.stations.ONT.lon),fetchAFD().catch(e=>{console.warn('AFD:',e);return null}),fetchMETARs().catch(e=>{console.warn('METAR:',e);return{}})]);
    rSurf(f70,metars);rProfile({F70:f70,SAN:san,ONT:ont});rHourly(f70);rComp({SAN:san,ONT:ont,F70:f70});
    if(afd)rAFD(afd);else document.getElementById('afdB').innerHTML='<div class="err">AFD unavailable</div>';
    document.getElementById('upd').textContent='Updated '+new Date().toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',second:'2-digit',hour12:true,timeZone:'America/Los_Angeles'});
  }catch(e){console.error(e);document.getElementById('surfB').innerHTML=`<div class="err">Error: ${e.message}</div>`}
  finally{busy=false;document.getElementById('rbtn').classList.remove('ld')}}
document.addEventListener('DOMContentLoaded',()=>{refreshAll();setInterval(refreshAll,5*60*1000)});
</script>
</body>
</html>
